{"version":3,"file":"requisite-autocomplete.bundle.js","sources":["../src/requisite-autocomplete.js"],"sourcesContent":["import {EventEmitter} from \"main.core.events\";\nimport {Dom, Loc, Tag, Type} from \"main.core\";\nimport {RequisiteAutocompleteField} from \"crm.entity-editor.field.requisite.autocomplete\";\n\nexport class EntityEditorRequisiteAutocomplete extends BX.UI.EntityEditorField\n{\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis._autocomplete = null;\n\t\tthis._autocompleteData = null;\n\t}\n\n\tdoInitialize()\n\t{\n\t\tlet params = this._schemeElement.getData();\n\t\tlet enabled = BX.prop.getBoolean(params, \"enabled\", false);\n\n\t\tthis._autocomplete = RequisiteAutocompleteField.create(this.getName(), {\n\t\t\tplaceholderText: BX.prop.getString(params, \"placeholder\", \"\"),\n\t\t\tenabled: enabled,\n\t\t\tfeatureRestrictionCallback: BX.prop.getString(params, \"featureRestrictionCallback\", ''),\n\t\t\tsearchAction: 'crm.requisite.entity.search',\n\t\t\tfeedbackFormParams: BX.prop.getObject(params, \"feedback_form\", {}),\n\t\t\tshowFeedbackLink: !enabled,\n\t\t\tclientResolverPlacementParams: BX.prop.getObject(params, \"clientResolverPlacementParams\", null)\n\t\t});\n\t\tthis._autocomplete.subscribe('onSelectValue', this.onSelectAutocompleteValue.bind(this));\n\t\tthis._autocomplete.subscribe('onClear', this.onClearAutocompleteValue.bind(this));\n\t\tthis._autocomplete.subscribe('onInstallDefaultApp', this.onInstallDefaultApp.bind(this));\n\t\tEventEmitter.subscribe(\n\t\t\t\"BX.Crm.RequisiteAutocomplete:onAfterInstallDefaultApp\",\n\t\t\tthis.onInstallDefaultAppGlobal.bind(this)\n\t\t);\n\t}\n\n\tcreateTitleMarker()\n\t{\n\t\tif(this._mode === BX.UI.EntityEditorMode.view)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tlet restrictionCallback = BX.prop.getString(this._schemeElement.getData(), \"featureRestrictionCallback\", '');\n\t\tif (restrictionCallback === '')\n\t\t{\n\t\t\treturn super.createTitleMarker();\n\t\t}\n\t\tlet lockIcon = Tag.render` <span class=\"tariff-lock\"></span>`;\n\t\tlockIcon.setAttribute('onclick', restrictionCallback);\n\t\treturn lockIcon;\n\t}\n\n\tlayout(options)\n\t{\n\t\tif (this._hasLayout)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._mode === BX.UI.EntityEditorMode.view)\n\t\t{\n\t\t\tif(!this._wrapper)\n\t\t\t{\n\t\t\t\tthis._wrapper = BX.create(\"div\");\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.ensureWrapperCreated({ classNames: [ \"ui-entity-editor-field-text\" ] });\n\t\t\tthis.adjustWrapper();\n\t\t}\n\n\t\tif (!this.isNeedToDisplay())\n\t\t{\n\t\t\tthis.registerLayout(options);\n\t\t\tthis._hasLayout = true;\n\t\t\treturn;\n\t\t}\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tDom.append(this.createDragButton(), this._wrapper);\n\t\t}\n\n\t\tDom.append(this.createTitleNode(this.getTitle()), this._wrapper);\n\n\t\tif (this._mode === BX.UI.EntityEditorMode.edit)\n\t\t{\n\t\t\tlet autocompleteContainer = Tag.render`<div class=\"ui-entity-editor-content-block\"></div>`;\n\t\t\tthis._autocomplete.layout(autocompleteContainer);\n\t\t\tthis.updateAutocompleteState();\n\t\t\tDom.append(autocompleteContainer, this._wrapper);\n\t\t}\n\n\t\tif (this.isContextMenuEnabled())\n\t\t{\n\t\t\tthis._wrapper.appendChild(this.createContextMenuButton());\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tthis.initializeDragDropAbilities();\n\t\t}\n\n\t\tthis.registerLayout(options);\n\t\tthis._hasLayout = true;\n\t}\n\n\tisNeedToDisplay()\n\t{\n\t\treturn super.isNeedToDisplay() && this._mode === BX.UI.EntityEditorMode.edit;\n\t}\n\n\tupdateAutocompleteState()\n\t{\n\t\tlet autocompleteState = null;\n\t\ttry\n\t\t{\n\t\t\tautocompleteState = JSON.parse(this.getValue());\n\t\t}\n\t\tcatch (e)\n\t\t{}\n\t\tthis._autocomplete.setState(autocompleteState);\n\t\tthis._autocomplete.setContext(this.getAutocompleteContext());\n\t}\n\n\tonSelectAutocompleteValue(event)\n\t{\n\t\tthis._autocompleteData = event.getData();\n\t\tthis.markAsChanged();\n\t}\n\n\tonClearAutocompleteValue(event)\n\t{\n\t\tthis._autocomplete.setCurrentItem(null);\n\t\tthis._autocompleteData = null;\n\t}\n\n\tonInstallDefaultApp()\n\t{\n\t\tBX.onGlobalCustomEvent(\"BX.Crm.RequisiteAutocomplete:onAfterInstallDefaultApp\");\n\t}\n\n\tonInstallDefaultAppGlobal()\n\t{\n\t\tconst data = this._schemeElement.getData();\n\t\tif (\n\t\t\tType.isPlainObject(data)\n\t\t\t&& data.hasOwnProperty(\"clientResolverPlacementParams\")\n\t\t\t&& Type.isPlainObject(data[\"clientResolverPlacementParams\"])\n\t\t)\n\t\t{\n\t\t\tconst countryId = BX.prop.getInteger(data[\"clientResolverPlacementParams\"], \"countryId\", 0);\n\t\t\tif (countryId > 0)\n\t\t\t{\n\t\t\t\tBX.ajax.runAction(\n\t\t\t\t\t'crm.requisite.schemedata.getRequisiteAutocompleteSchemeData',\n\t\t\t\t\t{ data: { \"countryId\": countryId } }\n\t\t\t\t).then(\n\t\t\t\t\t(data) => {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tType.isPlainObject(data)\n\t\t\t\t\t\t\t&& data.hasOwnProperty(\"data\")\n\t\t\t\t\t\t\t&& Type.isPlainObject(data[\"data\"])\n\t\t\t\t\t\t)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis._schemeElement.setData(data[\"data\"]);\n\t\t\t\t\t\t\tif (this._autocomplete)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (Type.isStringFilled(data[\"data\"][\"placeholder\"]))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis._autocomplete.setPlaceholderText(data[\"data\"][\"placeholder\"]);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (Type.isPlainObject(data[\"data\"][\"clientResolverPlacementParams\"]))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis._autocomplete.setClientResolverPlacementParams(\n\t\t\t\t\t\t\t\t\t\tdata[\"data\"][\"clientResolverPlacementParams\"]\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tgetAutocompleteData()\n\t{\n\t\treturn this._autocompleteData;\n\t}\n\n\tgetAutocompleteContext()\n\t{\n\t\treturn {\n\t\t\t'typeId': 'ITIN',\n\t\t\t'presetId': this._editor.getControlById('PRESET_ID').getValue()\n\t\t};\n\t}\n\n\tstatic create(id, settings)\n\t{\n\t\tlet self = new this(id, settings);\n\t\tself.initialize(id, settings);\n\t\treturn self;\n\t}\n\n\tstatic onInitializeEditorControlFactory(event)\n\t{\n\t\tlet data = event.getData();\n\t\tif (data[0])\n\t\t{\n\t\t\tdata[0].methods[\"requisite_autocomplete\"] = (type, controlId, settings) => {\n\t\t\t\tif (type === \"requisite_autocomplete\")\n\t\t\t\t{\n\t\t\t\t\treturn EntityEditorRequisiteAutocomplete.create(controlId, settings);\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\t\t}\n\t\tevent.setData(data);\n\t}\n\n}\n\nEventEmitter.subscribe('BX.UI.EntityEditorControlFactory:onInitialize', EntityEditorRequisiteAutocomplete.onInitializeEditorControlFactory);"],"names":["EntityEditorRequisiteAutocomplete","_autocomplete","_autocompleteData","params","_schemeElement","getData","enabled","BX","prop","getBoolean","RequisiteAutocompleteField","create","getName","placeholderText","getString","featureRestrictionCallback","searchAction","feedbackFormParams","getObject","showFeedbackLink","clientResolverPlacementParams","subscribe","onSelectAutocompleteValue","bind","onClearAutocompleteValue","onInstallDefaultApp","EventEmitter","onInstallDefaultAppGlobal","_mode","UI","EntityEditorMode","view","restrictionCallback","lockIcon","Tag","render","setAttribute","options","_hasLayout","_wrapper","ensureWrapperCreated","classNames","adjustWrapper","isNeedToDisplay","registerLayout","isDragEnabled","Dom","append","createDragButton","createTitleNode","getTitle","edit","autocompleteContainer","layout","updateAutocompleteState","isContextMenuEnabled","appendChild","createContextMenuButton","initializeDragDropAbilities","autocompleteState","JSON","parse","getValue","e","setState","setContext","getAutocompleteContext","event","markAsChanged","setCurrentItem","onGlobalCustomEvent","data","Type","isPlainObject","hasOwnProperty","countryId","getInteger","ajax","runAction","then","setData","isStringFilled","setPlaceholderText","setClientResolverPlacementParams","_editor","getControlById","id","settings","self","initialize","methods","type","controlId","EntityEditorField","onInitializeEditorControlFactory"],"mappings":"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"}