{"version":3,"file":"toolbar-component.bundle.js","sources":["../src/toolbar-component.js"],"sourcesContent":["import {Reflection, Event, ajax as Ajax, Text, Dom} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\nimport {BaseButton} from \"ui.buttons\";\nimport {Router} from \"crm.router\";\nimport {Menu} from \"main.popup\";\n\nimport 'ui.hint';\nimport 'toolbar-component.css';\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nlet instance = null;\n\nclass ToolbarEvents\n{\n\tstatic TYPE_UPDATED = 'TypeUpdated';\n\tstatic CATEGORIES_UPDATED = 'CategoriesUpdated';\n}\n\nclass ToolbarComponent extends EventEmitter\n{\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.initHints();\n\t\tthis.setEventNamespace('BX.Crm.ToolbarComponent');\n\n\t\tEvent.ready(this.bindEvents.bind(this));\n\t}\n\n\tstatic get Instance(): ToolbarComponent\n\t{\n\t\tif ( (window.top !== window) && Reflection.getClass('top.BX.Crm.ToolbarComponent') )\n\t\t{\n\t\t\treturn window.top.BX.Crm.ToolbarComponent.Instance;\n\t\t}\n\n\t\tif(instance === null)\n\t\t{\n\t\t\tinstance = new ToolbarComponent();\n\t\t}\n\n\t\treturn instance;\n\t}\n\n\tinitHints()\n\t{\n\t\tBX.UI.Hint.init(BX('ui-toolbar-after-title-buttons'));\n\t\tBX.UI.Hint.popupParameters = {\n\t\t\tcloseByEsc: true,\n\t\t\tautoHide: true,\n\t\t\tangle: { offset: 60 },\n\t\t\toffsetLeft: 40\n\t\t};\n\t}\n\n\tbindEvents()\n\t{\n\t\tconst buttonNode = document.querySelector('[data-role=\"bx-crm-toolbar-categories-button\"]');\n\t\tif (buttonNode)\n\t\t{\n\t\t\tconst toolbar =\tBX.UI.ToolbarManager.getDefaultToolbar();\n\t\t\tconst button = toolbar.getButton(Dom.attr(buttonNode, 'data-btn-uniqid'));\n\t\t\tconst entityTypeId = Number(buttonNode.dataset.entityTypeId);\n\t\t\tif (button && entityTypeId > 0)\n\t\t\t{\n\t\t\t\tthis.subscribeCategoriesUpdatedEvent(() => {\n\t\t\t\t\tthis.reloadCategoriesMenu(button, entityTypeId, buttonNode.dataset.categoryId);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\temitTypeUpdatedEvent(data)\n\t{\n\t\tthis.emit(ToolbarEvents.TYPE_UPDATED, data);\n\t}\n\n\temitCategoriesUpdatedEvent(data)\n\t{\n\t\tthis.emit(ToolbarEvents.CATEGORIES_UPDATED, data);\n\t}\n\n\tsubscribeTypeUpdatedEvent(callback)\n\t{\n\t\tthis.subscribe(ToolbarEvents.TYPE_UPDATED, callback);\n\t}\n\n\tsubscribeCategoriesUpdatedEvent(callback)\n\t{\n\t\tthis.subscribe(ToolbarEvents.CATEGORIES_UPDATED, callback);\n\t}\n\n\treloadCategoriesMenu(button: BaseButton, entityTypeId: number, categoryId: ?number)\n\t{\n\t\tconst menu = button.getMenuWindow();\n\t\tif (!menu)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tAjax.runAction('crm.controller.category.list', {\n\t\t\tdata: {\n\t\t\t\tentityTypeId\n\t\t\t}\n\t\t}).then((response) => {\n\t\t\tlet startKey = 0;\n\t\t\tconst items = [];\n\t\t\tconst categories = response.data.categories;\n\t\t\tmenu.menuItems.forEach((item) => {\n\t\t\t\tif (item.id.indexOf('toolbar-category-') !== 0)\n\t\t\t\t{\n\t\t\t\t\titems.push(item.options);\n\t\t\t\t}\n\t\t\t\telse if (item.id === 'toolbar-category-all')\n\t\t\t\t{\n\t\t\t\t\titems.push(item.options);\n\t\t\t\t\tstartKey = 1;\n\t\t\t\t}\n\t\t\t});\n\t\t\tmenu.destroy();\n\t\t\tEvent.unbindAll(button.getContainer(), 'click');\n\t\t\tcategories.forEach((category) => {\n\t\t\t\tlet link;\n\t\t\t\tif(entityTypeId === BX.CrmEntityType.enumeration.deal)\n\t\t\t\t{\n\t\t\t\t\tlink = '/crm/deal/category/' + category.id + '/';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tlink = Router.Instance.getItemListUrlInCurrentView(entityTypeId, category.id);\n\t\t\t\t\tlink = link.toString();\n\t\t\t\t}\n\n\t\t\t\titems.splice(startKey, 0, {\n\t\t\t\t\tid: 'toolbar-category-' + category.id,\n\t\t\t\t\ttext: Text.encode(category.name),\n\t\t\t\t\thref: link ? link : null,\n\t\t\t\t});\n\t\t\t\tif (category.id > 0 && categoryId > 0 && Number(categoryId) === Number(category.id))\n\t\t\t\t{\n\t\t\t\t\tbutton.setText(Text.encode(category.name));\n\t\t\t\t}\n\t\t\t\tstartKey++;\n\t\t\t});\n\t\t\tconst options = menu.params;\n\t\t\toptions.items = items;\n\t\t\tbutton.menuWindow = new Menu(options);\n\t\t\tEvent.bind(button.getContainer(), 'click', button.menuWindow.show.bind(button.menuWindow));\n\t\t}).catch((response) => {\n\t\t\tconsole.log('error trying reload categories', response.errors);\n\t\t});\n\t}\n}\n\nnamespace.ToolbarComponent = ToolbarComponent;\n"],"names":["namespace","Reflection","instance","ToolbarEvents","ToolbarComponent","initHints","setEventNamespace","Event","ready","bindEvents","bind","BX","UI","Hint","init","popupParameters","closeByEsc","autoHide","angle","offset","offsetLeft","buttonNode","document","querySelector","toolbar","ToolbarManager","getDefaultToolbar","button","getButton","Dom","attr","entityTypeId","Number","dataset","subscribeCategoriesUpdatedEvent","reloadCategoriesMenu","categoryId","data","emit","TYPE_UPDATED","CATEGORIES_UPDATED","callback","subscribe","menu","getMenuWindow","Ajax","runAction","then","response","startKey","items","categories","menuItems","forEach","item","id","indexOf","push","options","destroy","unbindAll","getContainer","category","link","CrmEntityType","enumeration","deal","Router","Instance","getItemListUrlInCurrentView","toString","splice","text","Text","encode","name","href","setText","params","menuWindow","Menu","show","console","log","errors","window","top","getClass","Crm","EventEmitter"],"mappings":"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"}