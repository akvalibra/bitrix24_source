{"version":3,"file":"script.js","sources":["src/js/document.js"],"sourcesContent":["import {Loc, Reflection, Tag} from \"main.core\";\nimport {BaseCard} from \"catalog.entity-card\";\nimport {EventEmitter} from \"main.core.events\";\nimport {Button, ButtonColor, ButtonState} from \"ui.buttons\";\n\nexport class Document extends BaseCard\n{\n\tstatic #instance;\n\n\tstatic saveAndDeductAction = 'saveAndDeduct';\n\tstatic deductAction = 'deduct';\n\tstatic cancelDeductAction = 'cancelDeduct';\n\n\tconstructor(id, settings)\n\t{\n\t\tsuper(id, settings);\n\t\tthis.isDocumentDeducted = settings.documentStatus === 'Y';\n\t\tthis.isDeductLocked = settings.isDeductLocked;\n\t\tthis.masterSliderUrl = settings.masterSliderUrl;\n\n\t\tthis.addCopyLinkPopup();\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onFailedValidation', (event) => {\n\t\t\tEventEmitter.emit('BX.Catalog.EntityCard.TabManager:onOpenTab', {tabId: 'main'});\n\t\t});\n\t\tEventEmitter.subscribe('onProductsCheckFailed', (event) => {\n\t\t\tEventEmitter.emit('BX.Catalog.EntityCard.TabManager:onOpenTab', {tabId: 'tab_products'});\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onSave', (event) => {\n\t\t\tconst eventEditor = event.data[0];\n\t\t\tif (eventEditor && eventEditor._ajaxForm)\n\t\t\t{\n\t\t\t\tlet action = eventEditor._ajaxForm?._actionName === 'SAVE' ? 'save' : eventEditor._ajaxForm?._config.data.ACTION;\n\t\t\t\tif (action === Document.saveAndDeductAction)\n\t\t\t\t{\n\t\t\t\t\tconst controllersErrorCollection = this.getControllersIssues(eventEditor.getControllers());\n\t\t\t\t\tif (controllersErrorCollection.length > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tevent.data[1].cancel = true;\n\t\t\t\t\t\teventEditor._toolPanel?.setLocked(false);\n\t\t\t\t\t\teventEditor._toolPanel?.addError(controllersErrorCollection[0]);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (action === 'SAVE')\n\t\t\t\t{\n\t\t\t\t\t// for consistency in analytics tags\n\t\t\t\t\taction = 'save';\n\t\t\t\t}\n\n\t\t\t\tlet urlParams = {\n\t\t\t\t\tisNewDocument: this.entityId <= 0 ? 'Y' : 'N',\n\t\t\t\t};\n\n\t\t\t\tif (action)\n\t\t\t\t{\n\t\t\t\t\turlParams.action = action;\n\t\t\t\t}\n\n\t\t\t\teventEditor._ajaxForm.addUrlParams(urlParams);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Catalog.EntityCard.TabManager:onSelectItem', (event) => {\n\t\t\tconst tabId = event.data.tabId;\n\t\t\tif (tabId === 'tab_products' && !this.isTabAnalyticsSent)\n\t\t\t{\n\t\t\t\tthis.sendAnalyticsData({\n\t\t\t\t\ttab: 'products',\n\t\t\t\t\tisNewDocument: this.entityId <= 0 ? 'Y' : 'N',\n\t\t\t\t\tdocumentType: 'W',\n\t\t\t\t});\n\t\t\t\tthis.isTabAnalyticsSent = true;\n\t\t\t}\n\t\t});\n\n\t\tDocument.#instance = this;\n\n\t\tBX.UI.SidePanel.Wrapper.setParam(\"closeAfterSave\", true);\n\t\tthis.showNotificationOnClose = false;\n\t}\n\n\tgetControllersIssues(controllers)\n\t{\n\t\tlet validateErrorCollection = [];\n\t\tif (controllers instanceof Array)\n\t\t{\n\t\t\tcontrollers.forEach((controller) => {\n\t\t\t\tif (controller instanceof BX.Crm.EntityStoreDocumentProductListController)\n\t\t\t\t{\n\t\t\t\t\tvalidateErrorCollection.push(...controller.getErrorCollection());\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn validateErrorCollection;\n\t}\n\n\tstatic getInstance()\n\t{\n\t\treturn Document.#instance;\n\t}\n\n\topenMasterSlider()\n\t{\n\t\tlet card = this;\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tthis.masterSliderUrl,\n\t\t\t{\n\t\t\t\tcacheable: false,\n\t\t\t\tdata: {\n\t\t\t\t\topenGridOnDone: false,\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tonCloseComplete: function(event) {\n\t\t\t\t\t\tlet slider = event.getSlider();\n\t\t\t\t\t\tif (!slider)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (slider.getData().get('isInventoryManagementEnabled'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcard.isDeductLocked = false;\n\n\t\t\t\t\t\t\tlet sliders = BX.SidePanel.Instance.getOpenSliders();\n\t\t\t\t\t\t\tsliders.forEach((slider) => {\n\t\t\t\t\t\t\t\tif (slider.getWindow()?.BX.Catalog?.DocumentGridManager)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tslider.allowChangeHistory = false;\n\t\t\t\t\t\t\t\t\tslider.getWindow().location.reload();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n\t/**\n\t * adds the \"deduct\" and \"save and deduct\" buttons to the tool panel\n\t * using entity-editor's api to preserve the logic\n\t */\n\tadjustToolPanel()\n\t{\n\t\tlet editor = this.getEditorInstance();\n\t\tif (!editor)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet savePanel = editor._toolPanel;\n\t\tlet saveButton = editor._toolPanel._editButton;\n\n\t\tthis.defaultSaveActionName = editor._ajaxForm._config.data.ACTION;\n\t\tthis.defaultOnSuccessCallback = editor._ajaxForm._config.onsuccess;\n\n\t\tsaveButton.onclick = (event) => {\n\t\t\tthis.showNotificationOnClose = false;\n\t\t\teditor._ajaxForm._config.data.ACTION = this.defaultSaveActionName;\n\t\t\teditor._ajaxForm._config.onsuccess = this.defaultOnSuccessCallback;\n\t\t\tsavePanel.onSaveButtonClick(event);\n\t\t};\n\n\t\tlet deductAndSaveButton = Tag.render`<button class=\"ui-btn ui-btn-light-border\">${Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_SAVE_AND_DEDUCT_BUTTON')}</button>`;\n\t\tdeductAndSaveButton.onclick = (event) => {\n\t\t\tif (this.isDeductLocked)\n\t\t\t{\n\t\t\t\tthis.openMasterSlider();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\teditor._ajaxForm._config.data.ACTION = Document.saveAndDeductAction;\n\t\t\teditor._ajaxForm._config.onsuccess = (result) => {\n\t\t\t\tthis.showNotificationOnClose = true;\n\t\t\t\tlet error = BX.prop.getString(result, 'ERROR', '');\n\t\t\t\tif (!error)\n\t\t\t\t{\n\t\t\t\t\tthis.setViewModeButtons(editor);\n\t\t\t\t}\n\n\t\t\t\teditor.onSaveSuccess(result);\n\t\t\t};\n\n\t\t\tsavePanel.onSaveButtonClick(event);\n\t\t};\n\t\tsaveButton.after(deductAndSaveButton);\n\t\tthis.deductAndSaveButton = deductAndSaveButton;\n\n\t\tlet deductButton = new Button({\n\t\t\ttext: this.isDocumentDeducted ? Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_CANCEL_DEDUCT_BUTTON') : Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_DEDUCT_BUTTON'),\n\t\t\tcolor: ButtonColor.LIGHT_BORDER,\n\t\t\tonclick: (button, event) => {\n\t\t\t\tif (savePanel.isLocked())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (this.isDeductLocked)\n\t\t\t\t{\n\t\t\t\t\tthis.openMasterSlider();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbutton.setState(ButtonState.CLOCKING);\n\t\t\t\tsavePanel.setLocked(true);\n\n\t\t\t\tconst actionName = this.isDocumentDeducted ? Document.cancelDeductAction : Document.deductAction;\n\t\t\t\tif (actionName === Document.deductAction)\n\t\t\t\t{\n\t\t\t\t\tconst controllers = editor.getControllers();\n\t\t\t\t\tlet errorCollection = [];\n\t\t\t\t\tcontrollers.forEach((controller) => {\n\t\t\t\t\t\tif (controller instanceof BX.Crm.EntityStoreDocumentProductListController)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!controller.validateProductList())\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\terrorCollection.push(...controller.getErrorCollection());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\n\t\t\t\t\tif (errorCollection.length > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tsavePanel.clearErrors();\n\t\t\t\t\t\tsavePanel.addError(errorCollection[0]);\n\t\t\t\t\t\tsavePanel.setLocked(false);\n\t\t\t\t\t\tbutton.setActive(true);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlet formData = {};\n\t\t\t\tif (window.EntityEditorDocumentOrderShipmentController)\n\t\t\t\t{\n\t\t\t\t\tformData = window.EntityEditorDocumentOrderShipmentController.demandFormData();\n\t\t\t\t}\n\n\t\t\t\tlet deductDocumentAjaxForm = editor.createAjaxForm(\n\t\t\t\t\t{\n\t\t\t\t\t\tactionName: actionName,\n\t\t\t\t\t\tenableRequiredUserFieldCheck: false,\n\t\t\t\t\t\tformData: formData,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tonSuccess: (result) => {\n\t\t\t\t\t\t\tif (!this.isDocumentDeducted)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.showNotificationOnClose = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbutton.setState(ButtonState.ACTIVE);\n\t\t\t\t\t\t\teditor.onSaveSuccess(result);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonFailure: (result) => {\n\t\t\t\t\t\t\tbutton.setState(ButtonState.ACTIVE);\n\t\t\t\t\t\t\teditor.onSaveFailure(result);\n\t\t\t\t\t\t},\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t\tdeductDocumentAjaxForm.addUrlParams({\n\t\t\t\t\taction: actionName,\n\t\t\t\t\tdocumentType: 'W',\n\t\t\t\t});\n\n\t\t\t\tdeductDocumentAjaxForm.submit();\n\t\t\t},\n\t\t}).render();\n\t\tsaveButton.after(deductButton);\n\t\tthis.deductButton = deductButton;\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onControlModeChange', (event) => {\n\t\t\tlet eventEditor = event.data[0];\n\t\t\tlet control = event.data[1].control;\n\t\t\tif(control.getMode() === BX.Crm.EntityEditorMode.edit)\n\t\t\t{\n\t\t\t\tthis.setEditModeButtons(eventEditor);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.setViewModeButtons(eventEditor);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onControlChange', (event) => {\n\t\t\tlet eventEditor = event.data[0];\n\t\t\tthis.setEditModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onControllerChange', (event) => {\n\t\t\tlet eventEditor = event.data[0];\n\t\t\tthis.setEditModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onSwitchToViewMode', (event) => {\n\t\t\tlet eventEditor = event.data[0];\n\t\t\tthis.setViewModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onNothingChanged', (event) => {\n\t\t\tlet eventEditor = event.data[0];\n\t\t\tthis.setViewModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('onEntityCreate', (event) => {\n\t\t\tlet editor = event?.data[0]?.sender;\n\t\t\tif (editor)\n\t\t\t{\n\t\t\t\teditor._toolPanel.disableSaveButton();\n\t\t\t\teditor.hideToolPanel();\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('beforeCrmEntityRedirect', (event) => {\n\t\t\tlet editor = event?.data[0]?.sender;\n\t\t\tif (editor)\n\t\t\t{\n\t\t\t\teditor._toolPanel.disableSaveButton();\n\t\t\t\teditor.hideToolPanel();\n\n\t\t\t\tif (this.showNotificationOnClose)\n\t\t\t\t{\n\t\t\t\t\tlet url = event.data[0].redirectUrl;\n\t\t\t\t\tif (!url)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\turl = BX.Uri.removeParam(url, 'closeOnSave');\n\n\t\t\t\t\twindow.top.BX.UI.Notification.Center.notify({\n\t\t\t\t\t\tcontent: Loc.getMessage('CRM_STORE_DOCUMENT_SAVE_AND_CONDUCT_NOTIFICATION'),\n\t\t\t\t\t\tactions: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttitle: Loc.getMessage('CRM_STORE_DOCUMENT_OPEN_DOCUMENT'),\n\t\t\t\t\t\t\t\thref: url,\n\t\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\tclick: function(event, balloon, action) {\n\t\t\t\t\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (editor.isNew())\n\t\t{\n\t\t\tthis.setEditModeButtons(editor);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setViewModeButtons(editor);\n\t\t}\n\t}\n\n\tsetViewModeButtons(editor)\n\t{\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_cancelButton'))\n\t\t{\n\t\t\tBX.hide(editor._toolPanel._cancelButton);\n\t\t}\n\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_editButton'))\n\t\t{\n\t\t\tBX.hide(editor._toolPanel._editButton);\n\t\t}\n\n\t\tif (this.deductAndSaveButton)\n\t\t{\n\t\t\tBX.hide(this.deductAndSaveButton);\n\t\t}\n\t\tif (this.deductButton)\n\t\t{\n\t\t\tBX.show(this.deductButton);\n\t\t}\n\t}\n\n\tsetEditModeButtons(editor)\n\t{\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_cancelButton'))\n\t\t{\n\t\t\tBX.show(editor._toolPanel._cancelButton);\n\t\t}\n\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_editButton'))\n\t\t{\n\t\t\tBX.show(editor._toolPanel._editButton);\n\t\t}\n\n\t\tif (this.deductAndSaveButton && !this.isDocumentDeducted)\n\t\t{\n\t\t\tBX.show(this.deductAndSaveButton);\n\t\t}\n\t\tif (this.deductButton && !this.isDocumentDeducted)\n\t\t{\n\t\t\tBX.hide(this.deductButton);\n\t\t}\n\t}\n\n\tgetEditorInstance()\n\t{\n\t\tif (Reflection.getClass('BX.Crm.EntityEditor'))\n\t\t{\n\t\t\treturn BX.Crm.EntityEditor.getDefault();\n\t\t}\n\n\t\treturn null;\n\t}\n\n\taddCopyLinkPopup()\n\t{\n\t\tlet copyLinkButton = document.getElementById(this.settings.copyLinkButtonId);\n\t\tif (!copyLinkButton)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tcopyLinkButton.onclick = () => {\n\t\t\tthis.copyDocumentLinkToClipboard();\n\t\t}\n\t}\n\n\tcopyDocumentLinkToClipboard()\n\t{\n\t\tlet url = BX.util.remove_url_param(window.location.href, [\"IFRAME\", \"IFRAME_TYPE\"]);\n\t\tif(!BX.clipboard.copy(url))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvar popup = new BX.PopupWindow(\n\t\t\t'catalog_copy_document_url_to_clipboard',\n\t\t\tdocument.getElementById(this.settings.copyLinkButtonId),\n\t\t\t{\n\t\t\t\tcontent: Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_LINK_COPIED'),\n\t\t\t\tdarkMode: true,\n\t\t\t\tautoHide: true,\n\t\t\t\tzIndex: 1000,\n\t\t\t\tangle: true,\n\t\t\t\tbindOptions: { position: \"top\" }\n\t\t\t}\n\t\t);\n\t\tpopup.show();\n\n\t\tsetTimeout(function(){ popup.close(); }, 1500);\n\t}\n\n\tsendAnalyticsData(data)\n\t{\n\t\tBX.ajax.runComponentAction(\n\t\t\t'bitrix:crm.store.document.detail',\n\t\t\t'sendAnalytics',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tanalyticsLabel: data,\n\t\t\t}\n\t\t);\n\t}\n}\n"],"names":["Document","id","settings","isDocumentDeducted","documentStatus","isDeductLocked","masterSliderUrl","addCopyLinkPopup","EventEmitter","subscribe","event","emit","tabId","eventEditor","data","_ajaxForm","action","_actionName","_config","ACTION","saveAndDeductAction","controllersErrorCollection","getControllersIssues","getControllers","length","cancel","_toolPanel","setLocked","addError","urlParams","isNewDocument","entityId","addUrlParams","isTabAnalyticsSent","sendAnalyticsData","tab","documentType","BX","UI","SidePanel","Wrapper","setParam","showNotificationOnClose","controllers","validateErrorCollection","Array","forEach","controller","Crm","EntityStoreDocumentProductListController","push","getErrorCollection","card","Instance","open","cacheable","openGridOnDone","events","onCloseComplete","slider","getSlider","getData","get","sliders","getOpenSliders","getWindow","Catalog","DocumentGridManager","allowChangeHistory","location","reload","editor","getEditorInstance","savePanel","saveButton","_editButton","defaultSaveActionName","defaultOnSuccessCallback","onsuccess","onclick","onSaveButtonClick","deductAndSaveButton","Tag","render","Loc","getMessage","openMasterSlider","result","error","prop","getString","setViewModeButtons","onSaveSuccess","after","deductButton","Button","text","color","ButtonColor","LIGHT_BORDER","button","isLocked","setState","ButtonState","CLOCKING","actionName","cancelDeductAction","deductAction","errorCollection","validateProductList","clearErrors","setActive","formData","window","EntityEditorDocumentOrderShipmentController","demandFormData","deductDocumentAjaxForm","createAjaxForm","enableRequiredUserFieldCheck","onSuccess","ACTIVE","onFailure","onSaveFailure","submit","control","getMode","EntityEditorMode","edit","setEditModeButtons","sender","disableSaveButton","hideToolPanel","url","redirectUrl","Uri","removeParam","top","Notification","Center","notify","content","actions","title","href","click","balloon","close","isNew","hasOwnProperty","hide","_cancelButton","show","Reflection","getClass","EntityEditor","getDefault","copyLinkButton","document","getElementById","copyLinkButtonId","copyDocumentLinkToClipboard","util","remove_url_param","clipboard","copy","popup","PopupWindow","darkMode","autoHide","zIndex","angle","bindOptions","position","setTimeout","ajax","runComponentAction","mode","analyticsLabel","BaseCard"],"mappings":"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"}