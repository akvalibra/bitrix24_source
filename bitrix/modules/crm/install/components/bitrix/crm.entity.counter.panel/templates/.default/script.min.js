this.BX=this.BX||{};(function(e,t,i,a){"use strict";function s(e,t){l(e,t);t.add(e)}function r(e,t,i){l(e,t);t.set(e,i)}function l(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function n(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var b=new WeakMap;var p=new WeakMap;var c=new WeakMap;var d=new WeakMap;var u=new WeakMap;var v=new WeakMap;var o=new WeakMap;var h=new WeakMap;var f=new WeakSet;var H=new WeakSet;var P=new WeakSet;var E=new WeakSet;var T=function(){function e(t){babelHelpers.classCallCheck(this,e);s(this,E);s(this,P);s(this,H);s(this,f);r(this,b,{writable:true,value:void 0});r(this,p,{writable:true,value:void 0});r(this,c,{writable:true,value:void 0});r(this,d,{writable:true,value:void 0});r(this,u,{writable:true,value:void 0});r(this,v,{writable:true,value:void 0});r(this,o,{writable:true,value:void 0});r(this,h,{writable:true,value:void 0});if(!i.Type.isPlainObject(t)){throw'BX.Crm.EntityCounterManager: The "options" argument must be object.'}babelHelpers.classPrivateFieldSet(this,b,i.Type.isString(t.id)?t.id:"");if(babelHelpers.classPrivateFieldGet(this,b)===""){throw'BX.Crm.EntityCounterManager: The "id" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,d,i.Type.isString(t.serviceUrl)?t.serviceUrl:"");if(babelHelpers.classPrivateFieldGet(this,d)===""){throw'BX.Crm.EntityCounterManager: The "serviceUrl" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,p,t.entityTypeId?i.Text.toInteger(t.entityTypeId):0);babelHelpers.classPrivateFieldSet(this,c,BX.CrmEntityType.resolveName(babelHelpers.classPrivateFieldGet(this,p)));babelHelpers.classPrivateFieldSet(this,u,i.Type.isArray(t.codes)?t.codes:[]);babelHelpers.classPrivateFieldSet(this,v,i.Type.isObject(t.extras)?t.extras:{});babelHelpers.classPrivateFieldSet(this,o,{});n(this,f,F).call(this);this.constructor.lastInstance=this}babelHelpers.createClass(e,[{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,b)}},{key:"getCounterData",value:function e(){return babelHelpers.classPrivateFieldGet(this,o)}},{key:"setCounterData",value:function e(t){babelHelpers.classPrivateFieldSet(this,o,t)}}],[{key:"getLastInstance",value:function e(){return this.lastInstance}}]);return e}();function F(){a.EventEmitter.subscribe("onPullEvent-main",n(this,H,y).bind(this))}function y(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),r=s[0],l=s[1];if(r!=="user_counter"){return}var b=false;var p=false;var c=i.Loc.getMessage("SITE_ID");var d=i.Type.isPlainObject(l[c])?l[c]:{};for(var v in d){if(!d.hasOwnProperty(v)||babelHelpers.classPrivateFieldGet(this,u).indexOf(v)<0){continue}var h=BX.prop.getInteger(d,v,0);if(h<0){p=true;break}var f=BX.prop.getInteger(babelHelpers.classPrivateFieldGet(this,o),v,0);if(f!==h){b=true;babelHelpers.classPrivateFieldGet(this,o)[v]=h}}if(p){n(this,P,I).call(this)}if(b){a.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}}function I(){if(babelHelpers.classPrivateFieldGet(this,h)){return}babelHelpers.classPrivateFieldSet(this,h,true);i.ajax({url:babelHelpers.classPrivateFieldGet(this,d),method:"POST",dataType:"json",data:{ACTION:"RECALCULATE",ENTITY_TYPES:[babelHelpers.classPrivateFieldGet(this,c)],EXTRAS:babelHelpers.classPrivateFieldGet(this,v)},onsuccess:BX.delegate(n(this,E,w),this)})}function w(e){babelHelpers.classPrivateFieldSet(this,h,false);var t=i.Type.isPlainObject(e["DATA"])?e["DATA"]:null;if(t===null){return}this.setCounterData(i.Type.isPlainObject(t[babelHelpers.classPrivateFieldGet(this,c)])?t[babelHelpers.classPrivateFieldGet(this,c)]:{});a.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}babelHelpers.defineProperty(T,"lastInstance",null);var C=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(C,"UNDEFINED",0);babelHelpers.defineProperty(C,"IDLE",1);babelHelpers.defineProperty(C,"PENDING",2);babelHelpers.defineProperty(C,"OVERDUE",4);babelHelpers.defineProperty(C,"CURRENT",6);babelHelpers.defineProperty(C,"ALL",7);babelHelpers.defineProperty(C,"IDLE_NAME","IDLE");babelHelpers.defineProperty(C,"PENDING_NAME","PENDING");babelHelpers.defineProperty(C,"OVERDUE_NAME","OVERDUE");babelHelpers.defineProperty(C,"CURRENT_NAME","CURRENT");babelHelpers.defineProperty(C,"ALL_NAME","ALL");function m(e,t){G(e,t);t.add(e)}function g(e,t,i){G(e,t);t.set(e,i)}function G(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function S(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var k=new WeakMap;var _=new WeakMap;var N=new WeakSet;var O=new WeakSet;var M=new WeakSet;var D=function(){function e(){babelHelpers.classCallCheck(this,e);m(this,M);m(this,O);m(this,N);g(this,k,{writable:true,value:void 0});g(this,_,{writable:true,value:void 0});var t=i.Type.isObject(BX.Main.filterManager)&&BX.Main.filterManager.hasOwnProperty("getList")?BX.Main.filterManager.getList():Object.values(BX.Main.filterManager.data);if(t.length===0){throw"BX.Crm.EntityCounterFilter: Unable to define filter."}babelHelpers.classPrivateFieldSet(this,k,t[0]);S(this,N,U).call(this);this.updateFields()}babelHelpers.createClass(e,[{key:"getManager",value:function e(){return babelHelpers.classPrivateFieldGet(this,k)}},{key:"getFields",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(i){var a=Object.entries(babelHelpers.classPrivateFieldGet(this,_)).filter((function(e){var i=babelHelpers.slicedToArray(e,2),a=i[0],s=i[1];return S(t,M,A).call(t,a)}));return Object.fromEntries(a)}return babelHelpers.classPrivateFieldGet(this,_)}},{key:"getApi",value:function e(){return babelHelpers.classPrivateFieldGet(this,k).getApi()}},{key:"updateFields",value:function e(){babelHelpers.classPrivateFieldSet(this,_,babelHelpers.classPrivateFieldGet(this,k).getFilterFieldsValues())}},{key:"isFilteredByFieldEx",value:function e(t){if(!Object.keys(babelHelpers.classPrivateFieldGet(this,_)).includes(t)||t.endsWith("_datesel")||t.endsWith("_numsel")||t.endsWith("_label")){return false}return S(this,M,A).call(this,t)}},{key:"isFiltered",value:function t(a,s,r){var l=this;if(a===0||s===C.UNDEFINED){return false}var n=r===BX.CrmEntityType.enumeration.order?true:this.isFilteredByFieldEx(e.COUNTER_USER_FIELD)&&i.Type.isArray(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_USER_FIELD])&&babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_USER_FIELD].length===1&&parseInt(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_USER_FIELD][0],10)===a;var b=this.isFilteredByFieldEx(e.COUNTER_TYPE_FIELD)&&i.Type.isObject(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_TYPE_FIELD])&&Object.values(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_TYPE_FIELD]).length===1&&parseInt(Object.values(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_TYPE_FIELD])[0],10)===s;var p=[e.COUNTER_USER_FIELD,e.COUNTER_TYPE_FIELD];var c=Object.keys(babelHelpers.classPrivateFieldGet(this,_));var d=p.filter((function(e){return!c.includes(e)})).concat(c.filter((function(e){return!p.includes(e)})));var u=d.some((function(e){return l.isFilteredByFieldEx(e)}));return n&&b&&!u}}]);return e}();function U(){a.EventEmitter.subscribe("BX.Main.Filter:apply",S(this,O,B).bind(this))}function B(){this.updateFields()}function A(e){if(i.Type.isArray(babelHelpers.classPrivateFieldGet(this,_)[e])){return babelHelpers.classPrivateFieldGet(this,_)[e].length>0}if(i.Type.isObject(babelHelpers.classPrivateFieldGet(this,_)[e])){return Object.values(babelHelpers.classPrivateFieldGet(this,_)[e]).length>0}return babelHelpers.classPrivateFieldGet(this,_)[e]!==""}babelHelpers.defineProperty(D,"COUNTER_TYPE_FIELD","ACTIVITY_COUNTER");babelHelpers.defineProperty(D,"COUNTER_USER_FIELD","ASSIGNED_BY_ID");function R(e,t){L(e,t);t.add(e)}function W(e,t,i){L(e,t);t.set(e,i)}function L(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function X(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var z=i.Reflection.namespace("BX.Crm");var j=new WeakMap;var x=new WeakMap;var Y=new WeakMap;var V=new WeakMap;var J=new WeakMap;var q=new WeakMap;var K=new WeakMap;var Q=new WeakMap;var Z=new WeakMap;var $=new WeakSet;var ee=new WeakSet;var te=new WeakSet;var ie=new WeakSet;var ae=new WeakSet;var se=new WeakSet;var re=new WeakSet;var le=new WeakSet;var ne=function(e){babelHelpers.inherits(t,e);function t(e){var a;babelHelpers.classCallCheck(this,t);if(!i.Type.isPlainObject(e)){throw'BX.Crm.EntityCounterPanel: The "options" argument must be object.'}var s=i.Type.isPlainObject(e.data)?e.data:{};a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{target:BX(e.id),items:t.getCounterItems(s),multiselect:false}));R(babelHelpers.assertThisInitialized(a),le);R(babelHelpers.assertThisInitialized(a),re);R(babelHelpers.assertThisInitialized(a),se);R(babelHelpers.assertThisInitialized(a),ae);R(babelHelpers.assertThisInitialized(a),ie);R(babelHelpers.assertThisInitialized(a),te);R(babelHelpers.assertThisInitialized(a),ee);R(babelHelpers.assertThisInitialized(a),$);W(babelHelpers.assertThisInitialized(a),j,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),x,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),Y,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),V,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),J,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),q,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),K,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),Q,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),Z,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),j,e.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),x,e.entityTypeId?i.Text.toInteger(e.entityTypeId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Y,e.userId?i.Text.toInteger(e.userId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),V,i.Type.isStringFilled(e.userName)?e.userName:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),Y));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),J,s);if(BX.CrmEntityType.isDefined(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),x))){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),q,new T({id:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),j),entityTypeId:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),x),serviceUrl:i.Type.isString(e.serviceUrl)?e.serviceUrl:"",codes:i.Type.isArray(e.codes)?e.codes:[],extras:i.Type.isObject(e.extras)?e.extras:{}}))}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),K,new D);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Q,e.filterLastPresetId);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Z,i.Type.isArray(e.filterLastPresetData)?JSON.parse(e.filterLastPresetData[0]):{presetId:null});X(babelHelpers.assertThisInitialized(a),$,be).call(babelHelpers.assertThisInitialized(a));return a}babelHelpers.createClass(t,[{key:"init",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"init",this).call(this);X(this,re,oe).call(this)}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,j)}}],[{key:"getCounterItems",value:function e(a){return Object.entries(a).map((function(e){var a=babelHelpers.slicedToArray(e,2),s=a[0],r=a[1];var l=parseInt(r.VALUE,10);return{id:s,title:i.Loc.getMessage("NEW_CRM_COUNTER_TYPE_"+r.TYPE_NAME),value:l,color:t.detectCounterItemColor(r.TYPE_NAME,l)}}),this)}},{key:"detectCounterItemColor",value:function e(t,i){return[C.IDLE_NAME,C.OVERDUE_NAME].includes(t)&&i>0?"DANGER":"THEME"}}]);return t}(t.CounterPanel);function be(){a.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",X(this,ee,pe).bind(this));a.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",X(this,te,ce).bind(this));a.EventEmitter.subscribe("BX.Main.Filter:apply",X(this,ie,de).bind(this));a.EventEmitter.subscribe("BX.Crm.EntityCounterManager:onRecalculate",X(this,ae,ue).bind(this))}function pe(e){var t=e.getData();if(!X(this,se,ve).call(this,t)){return BX.PreventDefault(e)}}function ce(){if(X(this,le,he).call(this)){var e=babelHelpers.classPrivateFieldGet(this,K).getApi();if(babelHelpers.classPrivateFieldGet(this,Z).presetId==="tmp_filter"){e.setFields(babelHelpers.classPrivateFieldGet(this,Z).fields);e.apply()}else{e.setFilter({preset_id:babelHelpers.classPrivateFieldGet(this,Z).presetId})}}}function de(){babelHelpers.classPrivateFieldGet(this,K).updateFields();X(this,re,oe).call(this)}function ue(){var e=babelHelpers.classPrivateFieldGet(this,q).getCounterData();for(var t in e){if(!e.hasOwnProperty(t)||!(t.indexOf("crm")===0&&e[t]>=0)||!babelHelpers.classPrivateFieldGet(this,J).hasOwnProperty(t)||i.Text.toNumber(babelHelpers.classPrivateFieldGet(this,J)[t].VALUE)===i.Text.toNumber(e[t])){continue}babelHelpers.classPrivateFieldGet(this,J)[t].VALUE=e[t];var a=this.getItemById(t);a.updateValue(i.Text.toNumber(e[t]));a.updateColor(ne.detectCounterItemColor(babelHelpers.classPrivateFieldGet(this,J)[t].TYPE_NAME,i.Text.toNumber(e[t])))}}function ve(e){var t=parseInt(babelHelpers.classPrivateFieldGet(this,J)[e.id].TYPE_ID,10);if(t>0){var i={userId:babelHelpers.classPrivateFieldGet(this,Y).toString(),userName:babelHelpers.classPrivateFieldGet(this,V),counterTypeId:t.toString(),cancel:false};var a=babelHelpers.classPrivateFieldGet(this,K).getFields(true);if(typeof a[D.COUNTER_TYPE_FIELD]==="undefined"){babelHelpers.classPrivateFieldGet(this,Z).presetId=babelHelpers.classPrivateFieldGet(this,K).getApi().parent.getPreset().getCurrentPresetId();if(babelHelpers.classPrivateFieldGet(this,Z).presetId==="tmp_filter"){babelHelpers.classPrivateFieldGet(this,Z).fields=a}BX.userOptions.save("crm",babelHelpers.classPrivateFieldGet(this,Q),"",JSON.stringify(babelHelpers.classPrivateFieldGet(this,Z)))}BX.onCustomEvent(window,"BX.CrmEntityCounterPanel:applyFilter",[this,i]);if(i.cancel){return false}}return true}function oe(){var e=this;Object.entries(babelHelpers.classPrivateFieldGet(this,J)).forEach((function(t){var i=babelHelpers.slicedToArray(t,2),a=i[0],s=i[1];var r=e.getItemById(a);babelHelpers.classPrivateFieldGet(e,K).isFiltered(babelHelpers.classPrivateFieldGet(e,Y),parseInt(s.TYPE_ID,10),babelHelpers.classPrivateFieldGet(e,x))?r.activate(false):r.deactivate(false);if(r.value!==r.counter.getValue()){r.updateValue(r.value)}}))}function he(){return this.getItems().every((function(e){return!e.isActive}))}z.EntityCounterPanel=ne})(this.BX.Crm=this.BX.Crm||{},BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js