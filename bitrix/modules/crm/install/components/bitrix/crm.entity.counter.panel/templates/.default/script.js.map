{"version":3,"file":"script.js","sources":["src/entity-counter-manager.js","src/entity-counter-type.js","src/entity-counter-filter-manager.js","src/entity-counter-panel.js"],"sourcesContent":["import { ajax as Ajax, Loc, Text, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\n\nimport type { EntityCounterManagerOptions } from './entity-counter-manager-options';\n\nexport default class EntityCounterManager\n{\n\tstatic lastInstance:?EntityCounterManager = null;\n\n\t#id: string;\n\t#entityTypeId: number;\n\t#entityTypeName: string;\n\t#serviceUrl: string;\n\t#codes: Array;\n\t#extras: Object;\n\t#withExcludeUsers: boolean = false;\n\t#counterData: Object;\n\t#isRequestRunning: boolean;\n\n\tconstructor(options: EntityCounterManagerOptions): void\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\tthrow 'BX.Crm.EntityCounterManager: The \"options\" argument must be object.';\n\t\t}\n\n\t\tthis.#id = Type.isString(options.id) ? options.id : '';\n\t\tif (this.#id === '')\n\t\t{\n\t\t\tthrow 'BX.Crm.EntityCounterManager: The \"id\" argument must be specified.';\n\t\t}\n\n\t\tthis.#serviceUrl = Type.isString(options.serviceUrl) ? options.serviceUrl : '';\n\t\tif (this.#serviceUrl === '')\n\t\t{\n\t\t\tthrow 'BX.Crm.EntityCounterManager: The \"serviceUrl\" argument must be specified.';\n\t\t}\n\n\t\tthis.#entityTypeId = options.entityTypeId ? Text.toInteger(options.entityTypeId) : 0;\n\t\tthis.#entityTypeName = BX.CrmEntityType.resolveName(this.#entityTypeId);\n\t\tthis.#codes = Type.isArray(options.codes) ? options.codes : [];\n\t\tthis.#extras = Type.isObject(options.extras) ? options.extras : {};\n\t\tthis.#withExcludeUsers = Type.isBoolean(options.withExcludeUsers) ? options.withExcludeUsers : false;\n\t\tthis.#counterData = {};\n\n\t\tthis.#bindEvents();\n\n\t\tthis.constructor.lastInstance = this;\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('onPullEvent-main', this.#onPullEvent.bind(this));\n\t}\n\n\t#onPullEvent(event: BaseEvent): void\n\t{\n\t\tconst [ command, params ] = event.getData();\n\t\tif (command !== 'user_counter')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet enableRecalculation = false;\n\t\tlet enableRecalculationWithRequest = false;\n\t\tconst currentSiteId = Loc.getMessage('SITE_ID');\n\t\tconst counterData = Type.isPlainObject(params[currentSiteId]) ? params[currentSiteId] : {};\n\t\tfor (let counterId in counterData)\n\t\t{\n\t\t\tif (\n\t\t\t\t!counterData.hasOwnProperty(counterId)\n\t\t\t\t|| this.#codes.indexOf(counterId) < 0\n\t\t\t)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst counterValue = BX.prop.getInteger(counterData, counterId, 0);\n\t\t\tif (counterValue < 0)\n\t\t\t{\n\t\t\t\tenableRecalculationWithRequest = true;\n\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst currentCounterValue = BX.prop.getInteger(this.#counterData, counterId, 0);\n\t\t\tif (currentCounterValue !== counterValue)\n\t\t\t{\n\t\t\t\tenableRecalculation = true;\n\n\t\t\t\t// update counter data\n\t\t\t\tthis.#counterData[counterId] = counterValue;\n\t\t\t}\n\t\t}\n\n\t\tif (enableRecalculationWithRequest)\n\t\t{\n\t\t\tthis.#startRecalculationRequest();\n\t\t}\n\n\t\tif (enableRecalculation)\n\t\t{\n\t\t\tEventEmitter.emit(this, 'BX.Crm.EntityCounterManager:onRecalculate');\n\t\t}\n\t}\n\n\t#startRecalculationRequest(): void\n\t{\n\t\tif (this.#isRequestRunning)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#isRequestRunning = true;\n\n\t\tAjax.runAction('crm.counter.list', {\n\t\t\tdata: {\n\t\t\t\tentityTypeId: this.#entityTypeId,\n\t\t\t\textras: this.#extras,\n\t\t\t\twithExcludeUsers: this.#withExcludeUsers ? 1 : 0,\n\t\t\t}\n\t\t}).then(this.#onRecalculationSuccess.bind(this));\n\t}\n\n\t#onRecalculationSuccess(result: Object): void\n\t{\n\t\tthis.#isRequestRunning = false;\n\n\t\tconst data = Type.isPlainObject(result.data) ? result.data : null;\n\t\tif (data === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.setCounterData(data);\n\n\t\tEventEmitter.emit('BX.Crm.EntityCounterManager:onRecalculate', this);\n\t}\n\n\tgetId(): string\n\t{\n\t\treturn this.#id;\n\t}\n\n\tgetCounterData(): Object\n\t{\n\t\treturn this.#counterData;\n\t}\n\n\tsetCounterData(data: Object): void\n\t{\n\t\tthis.#counterData = data;\n\t}\n\n\tstatic getLastInstance(): ?EntityCounterManager\n\t{\n\t\treturn this.lastInstance;\n\t}\n}\n","export default class EntityCounterType\n{\n\t// type ID\n\tstatic UNDEFINED = 0;\n\tstatic IDLE = 1;\n\tstatic PENDING = 2;\n\tstatic OVERDUE = 4;\n\tstatic CURRENT = 6; // PENDING|OVERDUE\n\tstatic ALL_DEADLINE_BASED = 7;  //IDLE|PENDING|OVERDUE\n\tstatic INCOMING_CHANNEL = 8;\n\tstatic ALL = 15;  //IDLE|PENDING|OVERDUE|INCOMING_CHANNEL\n\n\t// type name\n\tstatic IDLE_NAME  = 'IDLE';\n\tstatic PENDING_NAME = 'PENDING';\n\tstatic OVERDUE_NAME = 'OVERDUE';\n\tstatic CURRENT_NAME = 'CURRENT';\n\tstatic INCOMING_CHANNEL_NAME = 'INCOMINGCHANNEL';\n\tstatic ALL_DEADLINE_BASED_NAME = 'ALLDEADLINEBASED';\n\tstatic ALL_NAME = 'ALL';\n}\n","import { Type } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport EntityCounterType from './entity-counter-type';\n\nexport default class EntityCounterFilterManager\n{\n\tstatic COUNTER_TYPE_FIELD = 'ACTIVITY_COUNTER';\n\tstatic COUNTER_USER_FIELD = 'ASSIGNED_BY_ID';\n\n\tstatic EXCLUDED_FIELDS = [\n\t\t'FIND'\n\t];\n\n\tstatic FILTER_OTHER_USERS = 'other-users';\n\n\t#filterManager: BX.Main.Filter;\n\t#fields: Object;\n\t#isActive = true;\n\n\tconstructor()\n\t{\n\t\tconst filters = Type.isObject(BX.Main.filterManager) && BX.Main.filterManager.hasOwnProperty('getList')\n\t\t\t? BX.Main.filterManager.getList()\n\t\t\t: Object.values(BX.Main.filterManager.data);\n\n\t\tif (filters.length === 0)\n\t\t{\n\t\t\tconsole.warn('BX.Crm.EntityCounterFilter: Unable to define filter.');\n\t\t\tthis.#isActive = false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#filterManager = filters[0]; // use first filter to work\n\t\t\tthis.#bindEvents();\n\t\t\tthis.updateFields();\n\t\t}\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.#onFilterApply.bind(this));\n\t}\n\n\t#onFilterApply(): void\n\t{\n\t\tthis.updateFields();\n\t}\n\n\t#isFilteredByField(field: string): boolean\n\t{\n\t\tif (Type.isArray(this.#fields[field]))\n\t\t{\n\t\t\treturn this.#fields[field].length > 0;\n\t\t}\n\n\t\tif (Type.isObject(this.#fields[field]))\n\t\t{\n\t\t\treturn Object.values(this.#fields[field]).length > 0;\n\t\t}\n\n\t\treturn this.#fields[field] !== '';\n\t}\n\n\tgetManager(): BX.Main.filterManager\n\t{\n\t\treturn this.#filterManager;\n\t}\n\n\tisActive(): boolean\n\t{\n\t\treturn this.#isActive;\n\t}\n\n\tgetFields(isFilterEmpty: boolean = false): Object\n\t{\n\t\tif (isFilterEmpty)\n\t\t{\n\t\t\tconst filtered = Object.entries(this.#fields).filter(([field, value]) => this.#isFilteredByField(field));\n\n\t\t\treturn Object.fromEntries(filtered);\n\t\t}\n\n\t\treturn this.#fields;\n\t}\n\n\tgetApi(): BX.Filter.Api\n\t{\n\t\treturn this.#filterManager.getApi();\n\t}\n\n\tupdateFields(): void\n\t{\n\t\tthis.#fields = this.#filterManager.getFilterFieldsValues();\n\t}\n\n\tisFilteredByFieldEx(field: string): boolean\n\t{\n\t\tif (\n\t\t\t!Object.keys(this.#fields).includes(field)\n\t\t\t|| field.endsWith('_datesel')\n\t\t\t|| field.endsWith('_numsel')\n\t\t\t|| field.endsWith('_label')\n\t\t)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t\t\n\t\treturn this.#isFilteredByField(field);\n\t}\n\t\n\tisFiltered(userId: number, typeId: number, entityTypeId: number, isOtherUsersFilter: boolean): boolean\n\t{\n\t\tif (userId === 0 || typeId === EntityCounterType.UNDEFINED)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst isFilteredByUser = entityTypeId === BX.CrmEntityType.enumeration.order\n\t\t\t? true\n\t\t\t: this.isFilteredByFieldEx(EntityCounterFilterManager.COUNTER_USER_FIELD)\n\t\t\t\t&& Type.isArray(this.#fields[EntityCounterFilterManager.COUNTER_USER_FIELD])\n\t\t\t\t&& this.#fields[EntityCounterFilterManager.COUNTER_USER_FIELD].length === 1\n\t\t\t\t&& (\n\t\t\t\t\tisOtherUsersFilter\n\t\t\t\t\t\t? this.#fields[EntityCounterFilterManager.COUNTER_USER_FIELD][0] === EntityCounterFilterManager.FILTER_OTHER_USERS\n\t\t\t\t\t\t: parseInt(this.#fields[EntityCounterFilterManager.COUNTER_USER_FIELD][0], 10) === userId\n\t\t\t\t)\n\t\t;\n\n\t\tconst hasFilteredByTypeValue = this.isFilteredByFieldEx(EntityCounterFilterManager.COUNTER_TYPE_FIELD)\n\t\t\t&& Type.isObject(this.#fields[EntityCounterFilterManager.COUNTER_TYPE_FIELD])\n\t\t;\n\n\t\tconst filteredTypeValues = hasFilteredByTypeValue\n\t\t\t? Object.values(this.#fields[EntityCounterFilterManager.COUNTER_TYPE_FIELD])\n\t\t\t\t.map((item) => parseInt(item, 10))\n\t\t\t\t.sort()\n\t\t\t: []\n\t\t;\n\n\t\tconst isFilteredByType =\n\t\t\t(filteredTypeValues.length === 1 && filteredTypeValues[0] === typeId)\n\t\t\t|| (\n\t\t\t\tfilteredTypeValues.length === 2\n\t\t\t\t&& typeId === EntityCounterType.CURRENT\n\t\t\t\t&& filteredTypeValues[0] === EntityCounterType.PENDING\n\t\t\t\t&& filteredTypeValues[1] === EntityCounterType.OVERDUE\n\t\t\t)\n\t\t;\n\n\t\tlet counterFields = [\n\t\t\tEntityCounterFilterManager.COUNTER_USER_FIELD,\n\t\t\tEntityCounterFilterManager.COUNTER_TYPE_FIELD,\n\t\t\t... EntityCounterFilterManager.EXCLUDED_FIELDS\n\t\t];\n\n\t\tconst keysFields = Object.keys(this.#fields);\n\t\tconst otherFields = counterFields\n\t\t\t.filter(item => !keysFields.includes(item))\n\t\t\t.concat(keysFields.filter(x => !counterFields.includes(x))); // exclude checked fields\n\t\tconst isOtherFilterUsed = otherFields.some(item => this.isFilteredByFieldEx(item));\n\n\t\treturn isFilteredByUser && isFilteredByType && !isOtherFilterUsed;\n\t}\n}\n","import {Loc, Reflection, Text, Type} from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { CounterPanel, CounterItem } from 'ui.counterpanel';\nimport EntityCounterManager from './entity-counter-manager';\nimport EntityCounterType from './entity-counter-type';\nimport EntityCounterFilterManager from './entity-counter-filter-manager';\n\nimport type { EntityCounterPanelOptions } from './entity-counter-panel-options';\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nclass EntityCounterPanel extends CounterPanel\n{\n\tstatic EXCLUDE_USERS_CODE_SUFFIX = 'excl';\n\tstatic EXCLUDE_ALL_USERS_CODE_SUFFIX = 'all_excl';\n\n\t#id: String;\n\t#entityTypeId: Number;\n\t#userId: Number;\n\t#userName: String;\n\t#codes: Array;\n\t#data: Array;\n\t#counterManager: ?EntityCounterManager;\n\t#filterManager: ?EntityCounterFilterManager;\n\t#filterLastPresetId: String;\n\t#filterLastPreset: Object;\n\t#isNewCountersTourSeen: String;\n\n\tconstructor(options: EntityCounterPanelOptions): void\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\tthrow 'BX.Crm.EntityCounterPanel: The \"options\" argument must be object.';\n\t\t}\n\n\t\tconst data = Type.isPlainObject(options.data) ? options.data : {};\n\t\tconst withExcludeUsers = Type.isBoolean(options.withExcludeUsers) ? options.withExcludeUsers : false;\n\n\t\tsuper({\n\t\t\ttarget: BX(options.id),\n\t\t\titems: EntityCounterPanel.getCounterItems(data, options),\n\t\t\tmultiselect: false, // disable multiselect for CRM counters\n\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TITLE_MY')\n\t\t});\n\n\t\tthis.#id = options.id;\n\t\tthis.#entityTypeId = options.entityTypeId ? Text.toInteger(options.entityTypeId) : 0;\n\t\tthis.#userId = options.userId ? Text.toInteger(options.userId) : 0;\n\t\tthis.#userName = Type.isStringFilled(options.userName) ? options.userName : this.#userId;\n\t\tthis.#codes = Type.isArray(options.codes) ? options.codes : [];\n\t\tthis.#data = data;\n\n\t\tif (BX.CrmEntityType.isDefined(this.#entityTypeId))\n\t\t{\n\t\t\tthis.#counterManager = new EntityCounterManager({\n\t\t\t\tid: this.#id,\n\t\t\t\tentityTypeId: this.#entityTypeId,\n\t\t\t\tserviceUrl: Type.isString(options.serviceUrl) ? options.serviceUrl : '',\n\t\t\t\tcodes: this.#codes,\n\t\t\t\textras: Type.isObject(options.extras) ? options.extras : {},\n\t\t\t\twithExcludeUsers: withExcludeUsers,\n\t\t\t});\n\t\t}\n\n\t\tthis.#filterManager = new EntityCounterFilterManager();\n\t\tthis.#filterLastPresetId = options.filterLastPresetId;\n\t\tthis.#filterLastPreset = Type.isArray(options.filterLastPresetData)\n\t\t\t? JSON.parse(options.filterLastPresetData[0])\n\t\t\t: {presetId: null};\n\t\tthis.#isNewCountersTourSeen = options.isNewCountersTourSeen;\n\n\t\tthis.#bindEvents();\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:activate', this.#onActivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.UI.CounterPanel.Item:deactivate', this.#onDeactivateItem.bind(this));\n\t\tEventEmitter.subscribe('BX.Main.Filter:apply', this.#onFilterApply.bind(this));\n\t\tEventEmitter.subscribe('BX.Crm.EntityCounterManager:onRecalculate', this.#onRecalculate.bind(this));\n\t}\n\n\t#onActivateItem(event: BaseEvent): void\n\t{\n\t\tconst item = event.getData();\n\n\t\tif (!this.#processItemSelection(item))\n\t\t{\n\t\t\treturn BX.PreventDefault(event);\n\t\t}\n\t}\n\n\t#onDeactivateItem(event: BaseEvent): void\n\t{\n\t\tthis.#deactivateLinkedMenuItem(event.getData());\n\t\tif (this.#isAllDeactivated() && this.#filterManager.isActive())\n\t\t{\n\t\t\tconst api = this.#filterManager.getApi();\n\n\t\t\tif (this.#filterLastPreset.presetId === 'tmp_filter')\n\t\t\t{\n\t\t\t\tapi.setFields(this.#filterLastPreset.fields);\n\t\t\t\tapi.apply();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tapi.setFilter({preset_id: this.#filterLastPreset.presetId});\n\t\t\t}\n\t\t}\n\t}\n\n\t#onFilterApply(): void\n\t{\n\t\tif (this.#filterManager.isActive())\n\t\t{\n\t\t\tthis.#filterManager.updateFields();\n\t\t}\n\t\tthis.#markCounters();\n\t}\n\n\t#onRecalculate(): void\n\t{\n\t\tlet isValueUpdated = false;\n\n\t\tconst isNoSliders = BX.SidePanel.Instance.getTopSlider() === null;\n\t\tconst data = this.#counterManager.getCounterData();\n\t\tconst parentItem = this.getItemById(EntityCounterPanel.getMenuParentItemId(this.#codes));\n\n\t\tfor (let code in data)\n\t\t{\n\t\t\tif (\n\t\t\t\t!data.hasOwnProperty(code)\n\t\t\t\t|| !(code.indexOf('crm') === 0 && data[code] >= 0) // HACK: Skip of CRM counter reset\n\t\t\t\t|| !this.#data.hasOwnProperty(code)\n\t\t\t\t|| Text.toNumber(this.#data[code].VALUE) === Text.toNumber(data[code])\n\t\t\t)\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis.#data[code].VALUE = data[code];\n\n\t\t\tconst item = this.getItemById(code);\n\t\t\titem.updateValue(Text.toNumber(data[code]));\n\t\t\titem.updateColor(EntityCounterPanel.detectCounterItemColor(this.#data[code].TYPE_NAME, Text.toNumber(data[code])));\n\n\t\t\tisValueUpdated = isValueUpdated || true;\n\t\t}\n\n\t\tif (parentItem)\n\t\t{\n\t\t\tparentItem.updateValue(this.#getParentItemTotalValue());\n\t\t}\n\n\t\tif (this.#isNewCountersTourSeen === 'N' && isValueUpdated && isNoSliders)\n\t\t{\n\t\t\tEventEmitter.emit(this, 'BX.Crm.EntityCounterPanel::onShowNewCountersTour', {\n\t\t\t\ttarget: '.ui-counter-panel__scope',\n\t\t\t\tstepId: 'step-new-counters',\n\t\t\t\tdelay: 1500,\n\t\t\t});\n\n\t\t\tthis.#isNewCountersTourSeen = 'Y';\n\t\t}\n\t}\n\n\t#processItemSelection(item: CounterItem): Boolean\n\t{\n\t\tconst isOtherUsersFilter = item.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);\n\t\tconst typeId = parseInt(this.#data[item.id].TYPE_ID, 10);\n\t\tif (typeId > 0)\n\t\t{\n\t\t\tconst eventArgs = {\n\t\t\t\tuserId: isOtherUsersFilter ? EntityCounterFilterManager.FILTER_OTHER_USERS : this.#userId.toString(),\n\t\t\t\tuserName: isOtherUsersFilter ? Loc.getMessage('NEW_CRM_COUNTER_TYPE_OTHER') : this.#userName,\n\t\t\t\tcounterTypeId: this.#prepareFilterTypeId(typeId),\n\t\t\t\tcancel: false\n\t\t\t};\n\n\t\t\tif (this.#filterManager.isActive())\n\t\t\t{\n\t\t\t\tconst filteredFields = this.#filterManager.getFields(true);\n\t\t\t\tif (typeof (filteredFields[EntityCounterFilterManager.COUNTER_TYPE_FIELD]) === 'undefined')\n\t\t\t\t{\n\t\t\t\t\tthis.#filterLastPreset.presetId = this.#filterManager.getApi().parent.getPreset().getCurrentPresetId();\n\t\t\t\t\tif (this.#filterLastPreset.presetId === 'tmp_filter')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#filterLastPreset.fields = filteredFields\n\t\t\t\t\t}\n\n\t\t\t\t\tBX.userOptions.save('crm', this.#filterLastPresetId, '', JSON.stringify(this.#filterLastPreset));\n\t\t\t\t}\n\n\t\t\t\tBX.onCustomEvent(window, 'BX.CrmEntityCounterPanel:applyFilter', [this, eventArgs]);\n\t\t\t\tif (eventArgs.cancel)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t#prepareFilterTypeId(typeId: Number): Object\n\t{\n\t\tif (typeId === EntityCounterType.CURRENT)\n\t\t{\n\t\t\treturn {\n\t\t\t\t0: EntityCounterType.OVERDUE.toString(),\n\t\t\t\t1: EntityCounterType.PENDING.toString(),\n\t\t\t}\n\t\t}\n\n\t\treturn typeId.toString();\n\t}\n\n\t#markCounters(): void\n\t{\n\t\tif (!this.#filterManager.isActive())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst parentItem = this.getItemById(EntityCounterPanel.getMenuParentItemId(this.#codes));\n\n\t\tlet isOtherUsersFilterUse = false;\n\n\t\tObject.entries(this.#data).forEach(([code, record]) => {\n\t\t\tlet item = this.getItemById(code);\n\n\t\t\tconst isOtherUsersFilter = item.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);\n\n\t\t\tif (this.#filterManager.isFiltered(this.#userId, parseInt(record.TYPE_ID, 10), this.#entityTypeId, isOtherUsersFilter))\n\t\t\t{\n\t\t\t\titem.activate(false);\n\n\t\t\t\tif (isOtherUsersFilter)\n\t\t\t\t{\n\t\t\t\t\tisOtherUsersFilterUse = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\titem.deactivate(false);\n\t\t\t}\n\n\t\t\t// TODO: need fix it in parent CounterItem class\n\t\t\tif (item.value !== item.counter.getValue())\n\t\t\t{\n\t\t\t\titem.updateValue(item.value);\n\t\t\t}\n\t\t});\n\n\t\tif (parentItem)\n\t\t{\n\t\t\tisOtherUsersFilterUse ? parentItem.activate(false) : parentItem.deactivate(false);\n\t\t}\n\t}\n\n\t#isAllDeactivated(): Boolean\n\t{\n\t\treturn this.getItems().every((record: CounterItem) => {\n\t\t\treturn !record.isActive\n\t\t});\n\t}\n\n\t#deactivateLinkedMenuItem(item: CounterItem): void\n\t{\n\t\tif (item.hasParentId())\n\t\t{\n\t\t\tconst parentItem = this.getItemById(EntityCounterPanel.getMenuParentItemId(this.#codes));\n\t\t\tparentItem.deactivate(false);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (item.parent)\n\t\t{\n\t\t\titem.getItems().forEach(childItemId => {\n\t\t\t\tlet childItem = this.getItemById(childItemId);\n\t\t\t\tif (childItem.isActive)\n\t\t\t\t{\n\t\t\t\t\tchildItem.deactivate(false);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t#getParentItemTotalValue(): number\n\t{\n\t\tlet result = 0;\n\n\t\tthis.getItems().forEach((record: CounterItem) => {\n\t\t\tif (record.hasParentId())\n\t\t\t{\n\t\t\t\tresult += record.value;\n\t\t\t}\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tinit(): void\n\t{\n\t\tsuper.init();\n\n\t\tthis.#markCounters();\n\t}\n\n\tgetId(): String\n\t{\n\t\treturn this.#id;\n\t}\n\n\tstatic getCounterItems(input: Object, options: EntityCounterPanelOptions): Array\n\t{\n\t\tconst withExcludeUsers = Type.isBoolean(options.withExcludeUsers) ? options.withExcludeUsers : false;\n\t\tconst parentItemId = EntityCounterPanel.getMenuParentItemId(Type.isArray(options.codes) ? options.codes : [])\n\n\t\tlet otherUsersItems = [];\n\t\tif (withExcludeUsers && !Type.isUndefined(parentItemId))\n\t\t{\n\t\t\tlet parentTotal = 0;\n\n\t\t\totherUsersItems = Object.entries(input).map(([code: String, item: Object]) => {\n\t\t\t\tif (code.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX))\n\t\t\t\t{\n\t\t\t\t\tconst value = parseInt(item.VALUE, 10);\n\n\t\t\t\t\tparentTotal += value;\n\n\t\t\t\t\tlet color = EntityCounterPanel.detectCounterItemColor(item.TYPE_NAME, value);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tid: code,\n\t\t\t\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TYPE_OTHER_' + item.TYPE_NAME),\n\t\t\t\t\t\tvalue: value,\n\t\t\t\t\t\tcolor: color === 'THEME' ? 'GRAY' : color, // override color to correct display on different themes\n\t\t\t\t\t\tparentId: parentItemId\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}, this);\n\n\t\t\t// add parent item\n\t\t\totherUsersItems = [{\n\t\t\t\tid: parentItemId,\n\t\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TYPE_OTHER_TITLE'),\n\t\t\t\tvalue: parentTotal,\n\t\t\t\tcolor: 'THEME'\n\t\t\t}].concat(otherUsersItems);\n\t\t}\n\n\t\tlet currentUserItems = Object.entries(input).map(([code: String, item: Object]) => {\n\t\t\tif (!code.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX))\n\t\t\t{\n\t\t\t\tconst value = parseInt(item.VALUE, 10);\n\n\t\t\t\treturn {\n\t\t\t\t\tid: code,\n\t\t\t\t\ttitle: Loc.getMessage('NEW_CRM_COUNTER_TYPE_' + item.TYPE_NAME),\n\t\t\t\t\tvalue: value,\n\t\t\t\t\tcolor: EntityCounterPanel.detectCounterItemColor(item.TYPE_NAME, value)\n\t\t\t\t};\n\t\t\t}\n\t\t}, this);\n\n\t\treturn currentUserItems.concat(otherUsersItems).filter(item => Type.isObject(item));\n\t}\n\n\tstatic getMenuParentItemId(codes: Array): ?String\n\t{\n\t\treturn codes.find(element => element.endsWith(EntityCounterPanel.EXCLUDE_ALL_USERS_CODE_SUFFIX));\n\t}\n\n\tstatic detectCounterItemColor(type: String, value: Number): String\n\t{\n\t\tconst isRedCounter = [\n\t\t\tEntityCounterType.IDLE_NAME,\n\t\t\tEntityCounterType.OVERDUE_NAME,\n\t\t\tEntityCounterType.CURRENT_NAME,\n\t\t].includes(type);\n\n\t\tconst isGreenCounter  =  [\n\t\t\tEntityCounterType.INCOMING_CHANNEL_NAME,\n\t\t].includes(type);\n\n\t\treturn (value > 0)\n\t\t\t? (isRedCounter ? 'DANGER' : (isGreenCounter ? 'SUCCESS' : 'THEME'))\n\t\t\t: 'THEME';\n\t}\n}\n\nnamespace.EntityCounterPanel = EntityCounterPanel;\n"],"names":["EntityCounterManager","options","Type","isPlainObject","isString","id","serviceUrl","entityTypeId","Text","toInteger","BX","CrmEntityType","resolveName","isArray","codes","isObject","extras","isBoolean","withExcludeUsers","constructor","lastInstance","data","EventEmitter","subscribe","bind","event","getData","command","params","enableRecalculation","enableRecalculationWithRequest","currentSiteId","Loc","getMessage","counterData","counterId","hasOwnProperty","indexOf","counterValue","prop","getInteger","currentCounterValue","emit","Ajax","runAction","then","result","setCounterData","EntityCounterType","EntityCounterFilterManager","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","filters","Main","filterManager","getList","Object","values","length","console","warn","_classPrivateMethodGet","updateFields","isFilterEmpty","filtered","entries","filter","field","value","fromEntries","getApi","getFilterFieldsValues","keys","includes","endsWith","userId","typeId","isOtherUsersFilter","UNDEFINED","isFilteredByUser","enumeration","order","isFilteredByFieldEx","COUNTER_USER_FIELD","FILTER_OTHER_USERS","parseInt","hasFilteredByTypeValue","COUNTER_TYPE_FIELD","filteredTypeValues","map","item","sort","isFilteredByType","CURRENT","PENDING","OVERDUE","counterFields","EXCLUDED_FIELDS","keysFields","otherFields","concat","x","isOtherFilterUsed","some","namespace","Reflection","EntityCounterPanel","target","items","getCounterItems","multiselect","title","isStringFilled","userName","isDefined","filterLastPresetId","filterLastPresetData","JSON","parse","presetId","isNewCountersTourSeen","input","parentItemId","getMenuParentItemId","otherUsersItems","isUndefined","parentTotal","code","EXCLUDE_USERS_CODE_SUFFIX","VALUE","color","detectCounterItemColor","TYPE_NAME","parentId","currentUserItems","find","element","EXCLUDE_ALL_USERS_CODE_SUFFIX","type","isRedCounter","IDLE_NAME","OVERDUE_NAME","CURRENT_NAME","isGreenCounter","INCOMING_CHANNEL_NAME","CounterPanel","PreventDefault","isActive","api","setFields","fields","apply","setFilter","preset_id","isValueUpdated","isNoSliders","SidePanel","Instance","getTopSlider","getCounterData","parentItem","getItemById","toNumber","updateValue","updateColor","stepId","delay","TYPE_ID","eventArgs","toString","counterTypeId","cancel","filteredFields","getFields","parent","getPreset","getCurrentPresetId","userOptions","save","stringify","onCustomEvent","window","isOtherUsersFilterUse","forEach","record","isFiltered","activate","deactivate","counter","getValue","getItems","every","hasParentId","childItemId","childItem"],"mappings":"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"}