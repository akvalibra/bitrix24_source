this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};(function(e,t,i,s,r){"use strict";const l={INIT:"init",ADDED:"added",LOADING:"loading",PENDING:"pending",UPLOADING:"uploading",ABORTED:"aborted",COMPLETE:"complete",LOAD_FAILED:"load-failed",UPLOAD_FAILED:"upload-failed"};const n={CLIENT:"client",SERVER:"server"};class a extends i.EventEmitter{constructor(e){super();this.setEventNamespace("BX.UI.Uploader.UploadController");this.server=e}getServer(){return this.server}upload(e){throw new Error("You must implement upload() method.")}abort(){throw new Error("You must implement abort() method.")}}class o extends i.EventEmitter{constructor(e){super();this.setEventNamespace("BX.UI.Uploader.LoadController");this.server=e}getServer(){return this.server}load(e){throw new Error("You must implement load() method.")}abort(){throw new Error("You must implement abort() method.")}}const h=window.crypto||window.msCrypto;const d=()=>`${1e7}-${1e3}-${4e3}-${8e3}-${1e11}`.replace(/[018]/g,(e=>(e^h.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)));const c=e=>{if(!t.Type.isStringFilled(e)){return""}const i=e.split("/").pop();if(/javascript/.test(i)){return"js"}if(/plain/.test(i)){return"txt"}if(/svg/.test(i)){return"svg"}if(/[a-z]+/.test(i)){return i}return""};let u=0;const g=(e,i)=>{if(!t.Type.isStringFilled(i)){const t=new Date;i=`File ${t.getFullYear()}-${t.getMonth()}-${t.getDate()}-${++u}`;const s=c(e.type);if(s){i+=`.${s}`}}try{return new File([e],i,{lastModified:Date.now(),lastModifiedDate:new Date,type:e.type})}catch(t){const s=e.slice(0,e.size,e.type);s.name=i;s.lastModified=Date.now();s.lastModifiedDate=new Date;return s}};const p=/^data:((?:\w+\/(?:(?!;).)+)?)((?:;[\w\W]*?[^;])*),(.+)$/;const f=e=>typeof e==="string"?e.match(p):false;const m=e=>{const t=atob(e.split(",")[1]);const i=e.split(",")[0].split(":")[1].split(";")[0];const s=new ArrayBuffer(t.length);const r=new Uint8Array(s);for(let e=0;e<t.length;e++){r[e]=t.charCodeAt(e)}return new Blob([s],{type:i})};const F=e=>{const i=t.Type.isStringFilled(e)?e.lastIndexOf("."):-1;return i>0?e.substring(i+1):""};const v=["jpg","bmp","jpeg","jpe","gif","png","webp"];const b=(e,i=null)=>{const s=t.Type.isFile(e)?e.name:e;const r=t.Type.isFile(e)?e.type:i;const l=F(s).toLowerCase();if(v.includes(l)){if(r===null||/^image\/[a-z0-9.-]+$/i.test(r)){return true}}return false};const y=(e,i=1024)=>{let s=0;const r=w();while(e>=i&&r[s+1]){e/=i;s++}return(t.Type.isInteger(e)?e:e.toFixed(1))+r[s]};let P=null;const w=()=>{if(P!==null){return P}const e=t.Loc.getMessage("UPLOADER_FILE_SIZE_POSTFIXES").split(/[|]/);P=t.Type.isArrayFilled(e)?e:["B","kB","MB","GB","TB"];return P};var S=babelHelpers.classPrivateFieldLooseKey("setProperty");class E extends i.EventEmitter{constructor(e,i={}){super();Object.defineProperty(this,S,{value:T});this.id=null;this.file=null;this.serverId=null;this.name="";this.originalName=null;this.size=0;this.type="";this.width=null;this.height=null;this.clientPreview=null;this.clientPreviewUrl=null;this.clientPreviewWidth=null;this.clientPreviewHeight=null;this.serverPreviewUrl=null;this.serverPreviewWidth=null;this.serverPreviewHeight=null;this.downloadUrl=null;this.removeUrl=null;this.status=l.INIT;this.origin=n.CLIENT;this.errors=[];this.progress=0;this.uploadController=null;this.loadController=null;this.setEventNamespace("BX.UI.Uploader.File");const s=t.Type.isPlainObject(i)?i:{};if(t.Type.isFile(e)){this.file=e}else if(t.Type.isBlob(e)){this.file=g(e,s.name||e.name)}else if(f(e)){const t=m(e);this.file=g(t,s.name)}else if(t.Type.isNumber(e)||t.Type.isStringFilled(e)){this.origin=n.SERVER;this.serverId=e;if(t.Type.isPlainObject(s)){this.setFile(s)}}this.id=t.Type.isStringFilled(s.id)?s.id:d();this.subscribeFromOptions(s.events)}load(){if(!this.canLoad()){return}this.setStatus(l.LOADING);this.emit("onLoadStart");this.loadController.load(this)}upload(){if(!this.canUpload()){return}let e=new i.BaseEvent({data:{file:this}});this.emit("onBeforeUpload",e);if(e.isDefaultPrevented()){return}this.setStatus(l.UPLOADING);e=new i.BaseEvent({data:{file:this.getFile()}});this.emitAsync("onPrepareFileAsync",e).then((e=>{const i=t.Type.isArrayFilled(e)&&t.Type.isFile(e[0])?e[0]:this.getFile();this.emit("onUploadStart");if(this.uploadController){this.uploadController.upload(i)}})).catch((e=>{console.error(e)}))}abort(){if(this.uploadController){this.uploadController.abort()}this.setStatus(l.ABORTED);this.emit("onAbort")}abortLoad(){if(this.loadController){this.loadController.abort()}this.setStatus(l.ABORTED);this.emit("onAbort")}cancel(){this.abort();this.emit("onCancel")}setUploadController(e){this.uploadController=e}setLoadController(e){this.loadController=e}isReadyToUpload(){return this.getStatus()===l.PENDING}isUploadable(){return this.uploadController!==null}isLoadable(){return this.loadController!==null}canUpload(){return this.isReadyToUpload()&&this.isUploadable()}canLoad(){return this.getStatus()===l.ADDED&&this.isLoadable()}isUploading(){return this.getStatus()===l.UPLOADING}isLoading(){return this.getStatus()===l.LOADING}isComplete(){return this.getStatus()===l.COMPLETE}isFailed(){return this.getStatus()===l.LOAD_FAILED||this.getStatus()===l.UPLOAD_FAILED}getFile(){return this.file}setFile(e){if(t.Type.isFile(e)){this.file=e}else if(t.Type.isPlainObject(e)){this.setName(e.name);this.setOriginalName(e.originalName);this.setType(e.type);this.setSize(e.size);this.setServerId(e.serverId);this.setWidth(e.width);this.setHeight(e.height);this.setClientPreview(e.clientPreview,e.clientPreviewWidth,e.clientPreviewHeight);this.setServerPreview(e.serverPreviewUrl,e.serverPreviewWidth,e.serverPreviewHeight);this.setDownloadUrl(e.downloadUrl);this.setRemoveUrl(e.removeUrl)}}getName(){return this.getFile()?this.getFile().name:this.name}setName(e){if(t.Type.isStringFilled(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("name",e)}}getOriginalName(){return this.originalName?this.originalName:this.getName()}setOriginalName(e){if(t.Type.isStringFilled(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("originalName",e)}}getExtension(){const e=this.getOriginalName();const t=e.lastIndexOf(".");return t>=0?e.substring(t+1).toLowerCase():""}getType(){return this.getFile()?this.getFile().type:this.type}setType(e){if(t.Type.isStringFilled(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("type",e)}}getSize(){return this.getFile()?this.getFile().size:this.size}getSizeFormatted(){return y(this.getSize())}setSize(e){if(t.Type.isNumber(e)&&e>=0){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("size",e)}}getId(){return this.id}getServerId(){return this.serverId}setServerId(e){if(t.Type.isNumber(e)||t.Type.isStringFilled(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("serverId",e)}}getStatus(){return this.status}setStatus(e){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("status",e);this.emit("onStatusChange")}getOrigin(){return this.origin}getDownloadUrl(){return this.downloadUrl}setDownloadUrl(e){if(t.Type.isStringFilled(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("downloadUrl",e)}}getRemoveUrl(){return this.removeUrl}setRemoveUrl(e){if(t.Type.isStringFilled(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("removeUrl",e)}}getWidth(){return this.width}setWidth(e){if(t.Type.isNumber(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("width",e)}}getHeight(){return this.height}setHeight(e){if(t.Type.isNumber(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("height",e)}}getPreviewUrl(){return this.getClientPreview()?this.getClientPreviewUrl():this.getServerPreviewUrl()}getPreviewWidth(){return this.getClientPreview()?this.getClientPreviewWidth():this.getServerPreviewWidth()}getPreviewHeight(){return this.getClientPreview()?this.getClientPreviewHeight():this.getServerPreviewHeight()}getClientPreview(){return this.clientPreview}setClientPreview(e,i=null,s=null){if(t.Type.isFile(e)||t.Type.isNull(e)){this.revokeClientPreviewUrl();babelHelpers.classPrivateFieldLooseBase(this,S)[S]("clientPreview",e);babelHelpers.classPrivateFieldLooseBase(this,S)[S]("clientPreviewWidth",i);babelHelpers.classPrivateFieldLooseBase(this,S)[S]("clientPreviewHeight",s)}}getClientPreviewUrl(){if(this.clientPreviewUrl===null&&this.getClientPreview()!==null){this.clientPreviewUrl=URL.createObjectURL(this.getClientPreview())}return this.clientPreviewUrl}revokeClientPreviewUrl(){if(this.clientPreviewUrl!==null){URL.revokeObjectURL(this.clientPreviewUrl)}this.clientPreviewUrl=null}getClientPreviewWidth(){return this.clientPreviewWidth}getClientPreviewHeight(){return this.clientPreviewHeight}getServerPreviewUrl(){return this.serverPreviewUrl}setServerPreview(e,i=null,s=null){if(t.Type.isStringFilled(e)||t.Type.isNull(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("serverPreviewUrl",e);babelHelpers.classPrivateFieldLooseBase(this,S)[S]("serverPreviewWidth",i);babelHelpers.classPrivateFieldLooseBase(this,S)[S]("serverPreviewHeight",s)}}getServerPreviewWidth(){return this.serverPreviewWidth}getServerPreviewHeight(){return this.serverPreviewHeight}isImage(){return b(this.getOriginalName(),this.getType())}getProgress(){return this.progress}setProgress(e){if(t.Type.isNumber(e)){babelHelpers.classPrivateFieldLooseBase(this,S)[S]("progress",e)}}addError(e){this.errors.push(e);this.emit("onStateChange")}getError(){return this.errors[0]||null}getErrors(){return this.errors}getState(){return JSON.parse(JSON.stringify(this))}toJSON(){return{id:this.getId(),serverId:this.getServerId(),status:this.getStatus(),name:this.getName(),originalName:this.getOriginalName(),size:this.getSize(),sizeFormatted:this.getSizeFormatted(),type:this.getType(),extension:this.getExtension(),origin:this.getOrigin(),isImage:this.isImage(),failed:this.isFailed(),width:this.getWidth(),height:this.getHeight(),progress:this.getProgress(),error:this.getError(),errors:this.getErrors(),previewUrl:this.getPreviewUrl(),previewWidth:this.getPreviewWidth(),previewHeight:this.getPreviewHeight(),clientPreviewUrl:this.getClientPreviewUrl(),clientPreviewWidth:this.getClientPreviewWidth(),clientPreviewHeight:this.getClientPreviewHeight(),serverPreviewUrl:this.getServerPreviewUrl(),serverPreviewWidth:this.getServerPreviewWidth(),serverPreviewHeight:this.getServerPreviewHeight(),downloadUrl:this.getDownloadUrl(),removeUrl:this.getRemoveUrl()}}}function T(e,t){this[e]=t;this.emit("onStateChange")}class U extends t.BaseError{constructor(e,...i){let s=t.Type.isString(i[0])?i[0]:null;let r=t.Type.isString(i[1])?i[1]:null;const l=t.Type.isPlainObject(i[i.length-1])?i[i.length-1]:{};const n={};Object.keys(l).forEach((e=>{n[`#${e}#`]=l[e]}));if(!t.Type.isString(s)&&t.Loc.hasMessage(`UPLOADER_${e}`)){s=t.Loc.getMessage(`UPLOADER_${e}`,n)}if(t.Type.isStringFilled(s)&&!t.Type.isString(r)&&t.Loc.hasMessage(`UPLOADER_${e}_DESC`)){r=t.Loc.getMessage(`UPLOADER_${e}_DESC`,n)}super(s,e,l);this.description="";this.origin="client";this.setDescription(r)}static createFromAjaxErrors(e){if(!t.Type.isArrayFilled(e)||!t.Type.isPlainObject(e[0])){return new this("SERVER_ERROR")}const i=e.find((e=>e.type==="file-uploader"));if(i&&!i.system){const{code:e,message:t,description:s,customData:r}=i;const l=new this(e,t,s,r);l.setOrigin("server");return l}else{let{code:i,message:s,description:r,customData:l}=e[0];if(i==="NETWORK_ERROR"){s=t.Loc.getMessage("UPLOADER_NETWORK_ERROR")}else{i=t.Type.isStringFilled(i)?i:"SERVER_ERROR";if(!t.Type.isStringFilled(r)){r=s;s=t.Loc.getMessage("UPLOADER_SERVER_ERROR")}}console.error("Uploader",e);const n=new this(i,s,r,l);n.setOrigin("server");return n}}getDescription(){return this.description}setDescription(e){if(t.Type.isString(e)){this.description=e}return this}getOrigin(){return this.origin}setOrigin(e){if(t.Type.isStringFilled(e)){this.origin=e}return this}clone(){const e=JSON.parse(JSON.stringify(this));const t=new U(e.code,e.message,e.description,e.customData);t.setOrigin(e.origin);return t}toJSON(){return{code:this.getCode(),message:this.getMessage(),description:this.getDescription(),origin:this.getOrigin(),customData:this.getCustomData()}}}class L{constructor(e,t){this.data=null;this.offset=0;this.retries=[];this.data=e;this.offset=t}getNextRetryDelay(){if(this.retries.length===0){return null}return this.retries.shift()}setRetries(e){if(t.Type.isArray(e)){this.retries=e}}getData(){return this.data}getOffset(){return this.offset}getSize(){return this.getData().size}}var C=babelHelpers.classPrivateFieldLooseKey("uploadChunk");var O=babelHelpers.classPrivateFieldLooseKey("retryUploadChunk");var A=babelHelpers.classPrivateFieldLooseKey("getNextChunk");class I extends a{constructor(e){super(e);Object.defineProperty(this,A,{value:D});Object.defineProperty(this,O,{value:z});Object.defineProperty(this,C,{value:H});this.file=null;this.chunkOffset=null;this.chunkTimeout=null;this.token=null;this.xhr=null;this.aborted=false}upload(e){if(this.chunkOffset!==null){return}this.file=e;const t=babelHelpers.classPrivateFieldLooseBase(this,A)[A]();if(t){babelHelpers.classPrivateFieldLooseBase(this,C)[C](t)}}abort(){if(this.xhr){this.aborted=true;this.xhr.abort();this.xhr=null}this.emit("onAbort");clearTimeout(this.chunkTimeout)}getFile(){return this.file}getChunkSize(){return this.getServer().getChunkSize()}getChunkOffset(){return this.chunkOffset}getToken(){return this.token}setToken(e){if(t.Type.isStringFilled(e)){this.token=e}}}function H(e){const i=this.getFile().size;const s=e.getOffset()===0&&i===e.getSize();let r=this.getFile().name;if(r.normalize){r=r.normalize()}const l=t.Type.isStringFilled(this.getFile().type)?this.getFile().type:"application/octet-stream";const n=[{name:"Content-Type",value:l},{name:"X-Upload-Content-Name",value:encodeURIComponent(r)}];if(!s){const t=e.getOffset();const s=e.getOffset()+e.getSize()-1;const r=`bytes ${t}-${s}/${i}`;n.push({name:"Content-Range",value:r})}const a=this.getServer().getControllerOptions();t.ajax.runAction("ui.fileuploader.upload",{headers:n,data:e.getData(),preparePost:false,getParameters:{controller:this.getServer().getController(),controllerOptions:a?JSON.stringify(a):null,token:this.getToken()||""},onrequeststart:e=>{this.xhr=e;this.aborted=false},onprogressupload:t=>{if(t.lengthComputable){const i=this.getFile().size;const s=Math.min(i,e.getOffset()+t.loaded);const r=i>0?Math.floor(s/i*100):100;this.emit("onProgress",{progress:r})}}}).then((t=>{if(t.data.token){this.setToken(t.data.token);const i=this.getFile().size;const s=i>0?Math.floor((e.getOffset()+e.getSize())/i*100):100;this.emit("onProgress",{progress:s});const r=babelHelpers.classPrivateFieldLooseBase(this,A)[A]();if(r){babelHelpers.classPrivateFieldLooseBase(this,C)[C](r)}else{this.emit("onProgress",{progress:100});this.emit("onUpload",{fileInfo:t.data.file})}}else{this.emit("onError",{error:new U("SERVER_ERROR")})}})).catch((t=>{if(this.aborted){return}const i=U.createFromAjaxErrors(t.errors);const s=i.getCode()==="NETWORK_ERROR";if(!s||!babelHelpers.classPrivateFieldLooseBase(this,O)[O](e)){this.emit("onError",{error:i})}}))}function z(e){const t=e.getNextRetryDelay();if(t===null){return false}clearTimeout(this.chunkTimeout);this.chunkTimeout=setTimeout((()=>{babelHelpers.classPrivateFieldLooseBase(this,C)[C](e)}),t);return true}function D(){if(this.getChunkOffset()!==null&&this.getChunkOffset()>=this.getFile().size){return null}if(this.getChunkOffset()===null){this.chunkOffset=0}let e;if(this.getChunkOffset()===0&&this.getFile().size<=this.getChunkSize()){e=new L(this.getFile(),this.getChunkOffset());this.chunkOffset=this.getFile().size}else{const t=Math.min(this.getChunkSize(),this.getFile().size-this.getChunkOffset());const i=this.getChunkOffset()+t;const s=this.getFile().slice(this.getChunkOffset(),i);e=new L(s,this.getChunkOffset());this.chunkOffset=i}e.setRetries([...this.getServer().getChunkRetryDelays()]);return e}const R=new WeakMap;function B(e,i){const s=e.getServer();let r=R.get(s);if(!r){r={tasks:[],load:t.Runtime.debounce(N,100,s),xhr:null};R.set(s,r)}r.tasks.push({controller:e,file:i});r.load()}function M(e){const t=e.getServer();const i=R.get(t);if(i){i.xhr.abort();i.xhr=null;R.delete(t);i.tasks.forEach((e=>{const{controller:t,file:i}=e;t.emit("onAbort")}))}}function N(){const e=this;const i=R.get(e);if(!i){return}const{tasks:s}=i;R.delete(e);const r=[];s.forEach((e=>{const{controller:t,file:i}=e;r.push(i.getServerId())}));const l=e.getControllerOptions();t.ajax.runAction("ui.fileuploader.load",{data:{fileIds:r},getParameters:{controller:e.getController(),controllerOptions:l?JSON.stringify(l):null},onrequeststart:e=>{i.xhr=e},onprogress:e=>{if(e.lengthComputable){const t=e.total>0?Math.floor(e.loaded/e.total*100):100;s.forEach((e=>{const{controller:i,file:s}=e;i.emit("onProgress",{file:s,progress:t})}))}}}).then((e=>{var t;if((t=e.data)!=null&&t.files){const t={};e.data.files.forEach((e=>{t[e.id]=e}));s.forEach((e=>{const{controller:i,file:s}=e;const r=t[s.getServerId()]||null;if(r&&r.success){i.emit("onProgress",{file:s,progress:100});i.emit("onLoad",{fileInfo:r.data.file})}else{const e=U.createFromAjaxErrors(r==null?void 0:r.errors);i.emit("onError",{error:e})}}))}else{const e=new U("SERVER_ERROR");s.forEach((t=>{const{controller:i}=t;i.emit("onError",{error:e.clone()})}))}})).catch((e=>{const t=U.createFromAjaxErrors(e.errors);s.forEach((e=>{const{controller:i}=e;i.emit("onError",{error:t.clone()})}))}))}class x extends o{constructor(e){super(e)}load(e){if(this.getServer().getController()){B(this,e)}else{this.emit("onProgress",{file:e,progress:100});this.emit("onLoad",{fileInfo:e})}}abort(){if(this.getServer().getController()){M(this)}}}class k extends o{constructor(e){super(e)}load(e){if(t.Type.isFile(e.getFile())){this.emit("onProgress",{file:e,progress:100});this.emit("onLoad",{fileInfo:e})}else{this.emit("onError",{error:new U("WRONG_FILE_SOURCE")})}}abort(){}}var j=babelHelpers.classPrivateFieldLooseKey("calcChunkSize");class _{constructor(e){Object.defineProperty(this,j,{value:W});this.controller=null;this.controllerOptions=null;this.uploadControllerClass=null;this.loadControllerClass=null;this.chunkSize=null;this.defaultChunkSize=null;this.chunkMinSize=null;this.chunkMaxSize=null;this.chunkRetryDelays=[1e3,3e3,6e3];const i=t.Type.isPlainObject(e)?e:{};this.controller=t.Type.isStringFilled(i.controller)?i.controller:null;this.controllerOptions=t.Type.isPlainObject(i.controllerOptions)?i.controllerOptions:null;const s=t.Type.isNumber(i.chunkSize)&&i.chunkSize>0?i.chunkSize:this.getDefaultChunkSize();this.chunkSize=i.forceChunkSize===true?s:babelHelpers.classPrivateFieldLooseBase(this,j)[j](s);if(i.chunkRetryDelays===false||i.chunkRetryDelays===null){this.chunkRetryDelays=[]}else if(t.Type.isArray(i.chunkRetryDelays)){this.chunkRetryDelays=i.chunkRetryDelays}["uploadControllerClass","loadControllerClass"].forEach((e=>{if(t.Type.isStringFilled(i[e])){this[e]=t.Runtime.getClass(i[e]);if(!t.Type.isFunction(i[e])){throw new Error(`Uploader.Server: "${e}" must be a function.`)}}else if(t.Type.isFunction(i[e])){this[e]=i[e]}}))}createUploadController(){if(this.uploadControllerClass){const e=new this.uploadControllerClass(this);if(!(e instanceof a)){throw new Error('Uploader.Server: "uploadControllerClass" must be an instance of AbstractUploadController.')}return e}else if(t.Type.isStringFilled(this.controller)){return new I(this)}return null}createLoadController(){if(this.loadControllerClass){const e=new this.loadControllerClass(this);if(!(e instanceof o)){throw new Error('Uploader.Server: "loadControllerClass" must be an instance of AbstractLoadController.')}return e}return new x(this)}createClientLoadController(){return new k(this)}getController(){return this.controller}getControllerOptions(){return this.controllerOptions}getChunkSize(){return this.chunkSize}getDefaultChunkSize(){if(this.defaultChunkSize===null){const e=t.Extension.getSettings("ui.uploader.core");this.defaultChunkSize=e.get("defaultChunkSize",5*1024*1024)}return this.defaultChunkSize}getChunkMinSize(){if(this.chunkMinSize===null){const e=t.Extension.getSettings("ui.uploader.core");this.chunkMinSize=e.get("chunkMinSize",1024*1024)}return this.chunkMinSize}getChunkMaxSize(){if(this.chunkMaxSize===null){const e=t.Extension.getSettings("ui.uploader.core");this.chunkMaxSize=e.get("chunkMaxSize",5*1024*1024)}return this.chunkMaxSize}getChunkRetryDelays(){return this.chunkRetryDelays}}function W(e){return Math.min(Math.max(this.getChunkMinSize(),e),this.getChunkMaxSize())}class V{constructor(e,t={}){this.uploader=null;this.uploader=e}getUploader(){return this.uploader}apply(...e){throw new Error("You must implement apply() method.")}}class K extends V{constructor(e,i={}){super(e);this.maxFileSize=null;this.minFileSize=null;this.maxTotalFileSize=null;this.imageMaxFileSize=null;this.imageMinFileSize=null;const s=t.Type.isPlainObject(i)?i:{};const r=["maxFileSize","minFileSize","maxTotalFileSize","imageMaxFileSize","imageMinFileSize"];r.forEach((e=>{this[e]=t.Type.isNumber(s[e])&&s[e]>=0?s[e]:this[e]}))}apply(e){return new Promise(((t,i)=>{if(this.maxFileSize!==null&&e.getSize()>this.maxFileSize){i(new U("MAX_FILE_SIZE_EXCEEDED",{maxFileSize:y(this.maxFileSize),maxFileSizeInBytes:this.maxFileSize}));return}if(this.minFileSize!==null&&e.getSize()<this.minFileSize){i(new U("MIN_FILE_SIZE_EXCEEDED",{minFileSize:y(this.minFileSize),minFileSizeInBytes:this.minFileSize}));return}if(e.isImage()){if(this.imageMaxFileSize!==null&&e.getSize()>this.imageMaxFileSize){i(new U("IMAGE_MAX_FILE_SIZE_EXCEEDED",{imageMaxFileSize:y(this.imageMaxFileSize),imageMaxFileSizeInBytes:this.imageMaxFileSize}));return}if(this.imageMinFileSize!==null&&e.getSize()<this.imageMinFileSize){i(new U("IMAGE_MIN_FILE_SIZE_EXCEEDED",{imageMinFileSize:y(this.imageMinFileSize),imageMinFileSizeInBytes:this.imageMinFileSize}));return}}if(this.maxTotalFileSize!==null){if(this.getUploader().getTotalSize()>this.maxTotalFileSize){i(new U("MAX_TOTAL_FILE_SIZE_EXCEEDED",{maxTotalFileSize:y(this.maxTotalFileSize),maxTotalFileSizeInBytes:this.maxTotalFileSize}));return}}t()}))}}const X=(e,i)=>{if(!t.Type.isArrayFilled(i)){return true}const s=e.type;const r=s.replace(/\/.*$/,"");for(let l=0;l<i.length;l++){if(!t.Type.isStringFilled(i[l])){continue}const n=i[l].trim().toLowerCase();if(n.charAt(0)==="."){if(e.name.toLowerCase().indexOf(n,e.name.length-n.length)!==-1){return true}}else if(/\/\*$/.test(n)){if(r===n.replace(/\/.*$/,"")){return true}}else if(s===n){return true}}return false};class $ extends V{constructor(e,t={}){super(e)}apply(e){return new Promise(((t,i)=>{if(X(e.getFile(),this.getUploader().getAcceptedFileTypes())){t()}else{i(new U("FILE_TYPE_NOT_ALLOWED"))}}))}}const G=e=>new Promise(((t,i)=>{const s=new FileReader;s.readAsArrayBuffer(e);s.onload=()=>{const e=s.result;t(e)};s.onerror=()=>{i(s.error)}}));const J=e=>{const t=[];for(let i=0;i<e.length;i++){t.push(e.charCodeAt(i)&255)}return t};const Q=(e,t,i)=>{for(let s=i,r=0;r<t.length;){if(e.getUint8(s++)!==t[r++]){return false}}return true};const Y=J("GIF87a");const q=J("GIF89a");class Z{getSize(e){return new Promise(((t,i)=>{if(e.size<10){return t(null)}const s=e.slice(0,10);G(s).then((e=>{const i=new DataView(e);if(!Q(i,Y,0)&&!Q(i,q,0)){return t(null)}t({width:i.getUint16(6,true),height:i.getUint16(8,true)})})).catch((()=>{t(null)}))}))}}const ee=J("\x89PNG\r\n\x1a\n");const te=J("IHDR");const ie=J("CgBI");class se{getSize(e){return new Promise(((t,i)=>{if(e.size<40){return t(null)}const s=e.slice(0,40);G(s).then((e=>{const i=new DataView(e);if(!Q(i,ee,0)){return t(null)}if(Q(i,ie,12)){if(Q(i,te,28)){t({width:i.getUint32(32),height:i.getUint32(36)})}else{t(null)}}else if(Q(i,te,12)){t({width:i.getUint32(16),height:i.getUint32(20)})}else{t(null)}})).catch((()=>{t(null)}))}))}}const re=16973;class le{getSize(e){return new Promise(((t,i)=>{if(e.size<26){return t(null)}const s=e.slice(0,26);G(s).then((e=>{const i=new DataView(e);if(!i.getUint16(0)===re){return t(null)}t({width:i.getUint32(18,true),height:Math.abs(i.getInt32(22,true))})})).catch((()=>{t(null)}))}))}}const ne=J("Exif\0\0");class ae{getSize(e){return new Promise(((t,i)=>{if(e.size<2){return t(null)}G(e).then((e=>{const i=new DataView(e);if(i.getUint8(0)!==255||i.getUint8(1)!==216){t(null)}let s=2;let r=-1;for(;;){if(i.byteLength-s<2){return t(null)}if(i.getUint8(s++)!==255){return t(null)}let e=i.getUint8(s++);let l;while(e===255){e=i.getUint8(s++)}if(208<=e&&e<=217||e===1){l=0}else if(192<=e&&e<=254){if(i.byteLength-s<2){return t(null)}l=i.getUint16(s)-2;s+=2}else{return t(null)}if(e===217||e===218){return t(null)}if(e===225&&l>=10&&Q(i,ne,s)){const e=new DataView(i.buffer,s+6,s+l);r=he(e)}if(l>=5&&192<=e&&e<=207&&e!==196&&e!==200&&e!==204){if(i.byteLength-s<l){return t(null)}let e=i.getUint16(s+3);let n=i.getUint16(s+1);if(r>=5&&r<=8){[e,n]=[n,e]}return t({width:e,height:n,orientation:r})}s+=l}})).catch((()=>{t(null)}))}))}}const oe={BIG_ENDIAN:19789,LITTLE_ENDIAN:18761};const he=e=>{const t=e.getUint16(0);const i=t===oe.BIG_ENDIAN;const s=t===oe.LITTLE_ENDIAN;if(i||s){return de(e,s)}return-1};const de=(e,t=false)=>{const i=8;const s=e.getUint16(i,t);const r=12;const l=2;for(let n=0;n<s;n++){const s=i+l+n*r;const a=s+r;if(s>e.byteLength){return-1}const o=new DataView(e.buffer,e.byteOffset+s,a-s);const h=o.getUint16(0,t);if(h===274){const e=o.getUint16(2,t);if(e!==3){return-1}const i=o.getUint32(4,t);if(i!==1){return-1}return o.getUint16(8,t)}}};const ce=1380533830;const ue=1464156752;const ge=1448097824;const pe=1448097868;const fe=1448097880;class me{getSize(e){return new Promise(((t,i)=>{if(e.size<16){return t(null)}const s=e.slice(0,30);G(s).then((e=>{const i=new DataView(e);if(i.getUint32(0)!==ce&&i.getUint32(8)!==ue){return t(null)}const s=i.getUint32(12);const r=new DataView(e,20,10);if(s===ge&&r.getUint8(0)!==47){t({width:r.getUint16(6,true)&16383,height:r.getUint16(8,true)&16383});return}else if(s===pe&&r.getUint8(0)===47){const e=r.getUint32(1,true);t({width:(e&16383)+1,height:(e>>14&16383)+1});return}else if(s===fe){const e=r.getUint8(0);const i=(e&192)===0;const s=(e&1)===0;if(i&&s){const e=1+(r.getUint8(6)<<16|r.getUint8(5)<<8|r.getUint8(4));const i=1+(r.getUint8(9)<<0|r.getUint8(8)<<8|r.getUint8(7));t({width:e,height:i});return}}t(null)})).catch((()=>{t(null)}))}))}}const Fe=new ae;const ve={gif:new Z,png:new se,bmp:new le,jpg:Fe,jpeg:Fe,jpe:Fe,webp:new me};const be=e=>{if(e.size===0){return Promise.resolve(null)}const t=F(e.name).toLowerCase();const i=e.type.replace(/^image\//,"");const s=ve[t]||ve[i];if(!s){return Promise.resolve(null)}return s.getSize(e)};class ye extends V{constructor(e,i={}){super(e);this.imageMinWidth=1;this.imageMinHeight=1;this.imageMaxWidth=1e4;this.imageMaxHeight=1e4;this.ignoreUnknownImageTypes=false;const s=t.Type.isPlainObject(i)?i:{};["imageMinWidth","imageMinHeight","imageMaxWidth","imageMaxHeight"].forEach((e=>{this[e]=t.Type.isNumber(s[e])&&s[e]>0?s[e]:this[e]}));if(t.Type.isBoolean(s["ignoreUnknownImageTypes"])){this.ignoreUnknownImageTypes=s["ignoreUnknownImageTypes"]}}apply(e){return new Promise(((t,i)=>{if(!e.isImage()){t();return}be(e.getFile()).then((({width:s,height:r})=>{e.setWidth(s);e.setHeight(r);if(s<this.imageMinWidth||r<this.imageMinHeight){i(new U("IMAGE_IS_TOO_SMALL",{minWidth:this.imageMinWidth,minHeight:this.imageMinHeight}))}else if(s>this.imageMaxWidth||r>this.imageMaxHeight){i(new U("IMAGE_IS_TOO_BIG",{maxWidth:this.imageMaxWidth,maxHeight:this.imageMaxHeight}))}else{t()}})).catch((()=>{if(this.ignoreUnknownImageTypes){t()}else{i(new U("IMAGE_TYPE_NOT_SUPPORTED"))}}))}))}}const Pe=e=>{const t=new Blob(["(",e.toString(),")()"],{type:"application/javascript"});const i=URL.createObjectURL(t);const s=new Worker(i);return{post:(e,t,i)=>{const r=d();s.onmessage=e=>{if(e.data.id===r){t(e.data.message)}};s.postMessage({id:r,message:e},i)},terminate:()=>{s.terminate();URL.revokeObjectURL(i)}}};const we=function(){self.onmessage=e=>{createImageBitmap(e.data.message.file).then((t=>{self.postMessage({id:e.data.id,message:t},[t])})).catch((()=>{self.postMessage({id:e.data.id,message:null},[])}))}};const Se=e=>new Promise(((t,i)=>{const s=document.createElement("img");const r=URL.createObjectURL(e);s.src=r;s.onerror=e=>{URL.revokeObjectURL(s.src);i(e)};s.onload=()=>{URL.revokeObjectURL(r);t({width:s.naturalWidth,height:s.naturalHeight,image:s})}}));const Ee=(e,t,i)=>{t=Math.round(t);i=Math.round(i);const s=document.createElement("canvas");s.width=t;s.height=i;const r=s.getContext("2d");r.drawImage(e,0,0,t,i);return s};const Te=e=>e.substr(0,e.lastIndexOf("."))||e;const Ue={jpeg:"jpg"};const Le=(e,t)=>{const i=Te(e);const s=t.split("/")[1];const r=Ue[s]||s;return`${i}.${r}`};const Ce=window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype;const Oe=window.HTMLCanvasElement&&Ce.toBlob;const Ae=(e,t,i)=>new Promise(((s,r)=>{if(Oe){e.toBlob((e=>{s(e)}),t,i)}else{const r=m(e.toDataURL(t,i));s(r)}}));const Ie="createImageBitmap"in window&&typeof ImageBitmap!=="undefined"&&ImageBitmap.prototype&&ImageBitmap.prototype.close;const He=(e,t)=>new Promise(((i,s)=>{const r=()=>{Se(e).then((({image:e})=>{l(e)})).catch((e=>{s(e)}))};const l=r=>{const{targetWidth:l,targetHeight:n}=ze(r,t);if(!l||!n){if("close"in r){r.close()}i({preview:e,width:r.width,height:r.height});return}const a=Ee(r,l,n);if("close"in r){r.close()}const{quality:o=.92,mimeType:h="image/jpeg"}=t;const d=/jpeg|png|webp/.test(e.type)?e.type:h;Ae(a,d,o).then((t=>{const s=Le(e.name,d);const r=g(t,s);i({preview:r,width:l,height:n})})).catch((()=>{s()}))};if(Ie){const t=Pe(we);t.post({file:e},(e=>{t.terminate();if(e){l(e)}else{r()}}))}else{r()}}));const ze=(e,t={})=>{let{mode:i="contain",upscale:s=false,width:r,height:l}=t;const n={targetWidth:0,targetHeight:0};if(!r&&!l){return n}if(r===null){r=l}else if(l===null){l=r}if(i!=="force"){const t=r/e.width;const a=l/e.height;let o=1;if(i==="cover"){o=Math.max(t,a)}else if(i==="contain"){o=Math.min(t,a)}if(o>1&&s===false){return n}r=e.width*o;l=e.height*o}n.targetWidth=Math.round(r);n.targetHeight=Math.round(l);return n};class De extends V{constructor(e,i={}){super(e);this.imagePreviewWidth=300;this.imagePreviewHeight=300;this.imagePreviewQuality=.92;this.imagePreviewMimeType="image/jpeg";this.imagePreviewUpscale=false;this.imagePreviewResizeMethod="contain";const s=t.Type.isPlainObject(i)?i:{};const r=["imagePreviewWidth","imagePreviewHeight","imagePreviewQuality"];r.forEach((e=>{this[e]=t.Type.isNumber(s[e])&&s[e]>0?s[e]:this[e]}));if(t.Type.isBoolean(s["imagePreviewUpscale"])){this.imagePreviewUpscale=s["imagePreviewUpscale"]}if(["contain","force","cover"].includes(s["imagePreviewResizeMethod"])){this.imagePreviewResizeMethod=s["imagePreviewResizeMethod"]}if(["image/jpeg","image/png"].includes(s["imagePreviewMimeType"])){this.imagePreviewMimeType=s["imagePreviewMimeType"]}}apply(e){return new Promise(((t,i)=>{if(!b(e.getFile())){t();return}const s={width:this.imagePreviewWidth,height:this.imagePreviewHeight,mode:this.imagePreviewResizeMethod,upscale:this.imagePreviewUpscale,quality:this.imagePreviewQuality,mimeType:this.imagePreviewMimeType};He(e.getFile(),s).then((({preview:i,width:s,height:r})=>{e.setClientPreview(i,s,r);t()})).catch((()=>{t()}))}))}}class Re extends V{constructor(e,i={}){super(e);this.resizeWidth=null;this.resizeHeight=null;this.resizeMethod="contain";this.resizeMimeType="image/jpeg";this.resizeQuality=.92;const s=t.Type.isPlainObject(i)?i:{};if(t.Type.isNumber(s["imageResizeWidth"])&&s["imageResizeWidth"]>0){this.resizeWidth=s["imageResizeWidth"]}if(t.Type.isNumber(s["imageResizeHeight"])&&s["imageResizeHeight"]>0){this.resizeHeight=s["imageResizeHeight"]}if(["contain","force","cover"].includes(s["imageResizeMethod"])){this.resizeMethod=s["imageResizeMethod"]}if(t.Type.isNumber(s["imageResizeQuality"])){this.resizeQuality=Math.min(Math.max(.1,s["imageResizeQuality"]),1)}if(["image/jpeg","image/png"].includes(s["imageResizeMimeType"])){this.resizeMimeType=s["imageResizeMimeType"]}}apply(e){return new Promise(((t,i)=>{if(!b(e)){return t(e)}if(this.resizeWidth===null&&this.resizeHeight===null){return t(e)}const s={width:this.resizeWidth,height:this.resizeHeight,mode:this.resizeMethod,quality:this.resizeQuality,mimeType:this.resizeMimeType};He(e,s).then((({preview:e})=>{t(e)})).catch((()=>{t(e)}))}))}}const Be={STARTED:0,STOPPED:1};const Me={VALIDATION:"validation",PREPARATION:"preparation"};const Ne=e=>new Promise(((t,i)=>{if(!e.items){t(e.files?Array.from(e.files):[]);return}const s=Array.from(e.items).filter((e=>xe(e))).map((e=>ke(e)));Promise.all(s).then((e=>{const i=[];e.forEach((e=>{i.push.apply(i,e)}));t(i)})).catch(i)}));const xe=e=>{if("webkitGetAsEntry"in e){const t=e.webkitGetAsEntry();if(t){return t.isFile||t.isDirectory}}return e.kind==="file"};const ke=e=>new Promise(((t,i)=>{if(_e(e)){je(Ve(e)).then(t).catch(i);return}t([e.getAsFile()])}));const je=e=>new Promise(((t,i)=>{const s=[];let r=0;let l=0;const n=()=>{if(l===0&&r===0){t(s)}};const a=e=>{r++;const t=e.createReader();const o=()=>{t.readEntries((e=>{if(e.length===0){r--;n();return}e.forEach((e=>{if(e.isDirectory){a(e)}else{l++;e.file((e=>{s.push(e);l--;n()}))}}));o()}),i)};o()};a(e)}));const _e=e=>We(e)&&(Ve(e)||{}).isDirectory;const We=e=>"webkitGetAsEntry"in e;const Ve=e=>e.webkitGetAsEntry();let Ke=null;const Xe=()=>{if(Ke===null){try{const e=new DataTransfer;const t=new File(["hello"],"my.txt");e.items.add(t);const i=document.createElement("input");i.setAttribute("type","file");i.files=e.files;Ke=i.files.length===1}catch(e){Ke=false}}return Ke};const $e=(e,i)=>{try{const s=new DataTransfer;const r=t.Type.isArray(i)?i:[i];r.forEach((e=>{s.items.add(e)}));e.files=s.files}catch(e){return false}return true};var Ge=babelHelpers.classPrivateFieldLooseKey("setLoadController");var Je=babelHelpers.classPrivateFieldLooseKey("setUploadController");var Qe=babelHelpers.classPrivateFieldLooseKey("exceedsMaxFileCount");var Ye=babelHelpers.classPrivateFieldLooseKey("applyFilters");var qe=babelHelpers.classPrivateFieldLooseKey("uploadNext");var Ze=babelHelpers.classPrivateFieldLooseKey("loadNext");var et=babelHelpers.classPrivateFieldLooseKey("setHiddenField");var tt=babelHelpers.classPrivateFieldLooseKey("resetHiddenField");var it=babelHelpers.classPrivateFieldLooseKey("syncInputPositions");class st extends i.EventEmitter{constructor(e){super();Object.defineProperty(this,it,{value:ut});Object.defineProperty(this,tt,{value:ct});Object.defineProperty(this,et,{value:dt});Object.defineProperty(this,Ze,{value:ht});Object.defineProperty(this,qe,{value:ot});Object.defineProperty(this,Ye,{value:at});Object.defineProperty(this,Qe,{value:nt});Object.defineProperty(this,Je,{value:lt});Object.defineProperty(this,Ge,{value:rt});this.files=[];this.multiple=false;this.autoUpload=true;this.allowReplaceSingle=true;this.maxParallelUploads=2;this.maxParallelLoads=10;this.acceptOnlyImages=false;this.acceptedFileTypes=[];this.ignoredFileNames=[".ds_store","thumbs.db","desktop.ini"];this.maxFileCount=null;this.server=null;this.hiddenFields=new Map;this.hiddenFieldsContainer=null;this.hiddenFieldName="file";this.assignAsFile=false;this.filters=new Map;this.status=Be.STOPPED;this.setEventNamespace("BX.UI.Uploader");const i=t.Type.isPlainObject(e)?Object.assign({},e):{};this.multiple=t.Type.isBoolean(i.multiple)?i.multiple:false;this.acceptOnlyImages=t.Type.isBoolean(i.acceptOnlyImages)?i.acceptOnlyImages:false;this.setAutoUpload(i.autoUpload);this.setMaxParallelUploads(i.maxParallelUploads);this.setMaxParallelLoads(i.maxParallelLoads);if(this.acceptOnlyImages){const e=t.Extension.getSettings("ui.uploader.core");const i=e.get("imageExtensions","jpg,bmp,jpeg,jpe,gif,png,webp");this.setAcceptedFileTypes(i)}this.setAcceptedFileTypes(i.acceptedFileTypes);this.setIgnoredFileNames(i.ignoredFileNames);this.setMaxFileCount(i.maxFileCount);this.setAllowReplaceSingle(i.allowReplaceSingle);this.assignBrowse(i.browseElement);this.assignDropzone(i.dropElement);this.assignPaste(i.pasteElement);this.setHiddenFieldsContainer(i.hiddenFieldsContainer);this.setHiddenFieldName(i.hiddenFieldName);this.setAssignAsFile(i.assignAsFile);let s=t.Type.isPlainObject(i.serverOptions)?i.serverOptions:{};s=Object.assign({},{controller:i.controller,controllerOptions:i.controllerOptions},s);this.server=new _(s);this.subscribeFromOptions(i.events);this.addFilter(Me.VALIDATION,new K(this,i));this.addFilter(Me.VALIDATION,new $(this,i));this.addFilter(Me.VALIDATION,new ye(this,i));this.addFilter(Me.VALIDATION,new De(this,i));this.addFilter(Me.PREPARATION,new Re(this,i));this.addFilters(i.filters);this.handleBeforeUpload=this.handleBeforeUpload.bind(this);this.handlePrepareFileAsync=this.handlePrepareFileAsync.bind(this);this.handleUploadStart=this.handleBeforeUpload.bind(this);this.handleFileCancel=this.handleFileCancel.bind(this);this.handleFileStatusChange=this.handleFileStatusChange.bind(this);this.handleFileStateChange=this.handleFileStateChange.bind(this);this.addFiles(i.files)}addFiles(e){if(!t.Type.isArrayLike(e)){return}const i=Array.from(e);if(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe](i)){return}i.forEach((e=>{if(t.Type.isArrayFilled(e)){this.addFile(e[0],e[1])}else{this.addFile(e)}}))}addFile(e,t){const s=new E(e,t);if(this.getIgnoredFileNames().includes(s.getName().toLowerCase())){return}if(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]([s])){return}if(!this.isMultiple()&&this.shouldReplaceSingle()&&this.getFiles().length>0){const e=this.getFiles()[0];this.removeFile(e)}const r=new i.BaseEvent({data:{file:s}});this.emit("File:onBeforeAdd",r);if(r.isDefaultPrevented()){return}babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge](s);babelHelpers.classPrivateFieldLooseBase(this,Je)[Je](s);this.files.push(s);s.setStatus(l.ADDED);this.emit("File:onAddStart",{file:s});s.subscribe("onBeforeUpload",this.handleBeforeUpload);s.subscribe("onPrepareFileAsync",this.handlePrepareFileAsync);s.subscribe("onUploadStart",this.handleUploadStart);s.subscribe("onCancel",this.handleFileCancel);s.subscribe("onStatusChange",this.handleFileStatusChange);s.subscribe("onStateChange",this.handleFileStateChange);if(s.getOrigin()===n.SERVER){s.load()}else{babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]()}}start(){if(this.getStatus()!==Be.STARTED&&this.getPendingFileCount()>0){this.status=Be.STARTED;this.emit("onUploadStart");babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]()}}stop(){this.status=Be.STOPPED;this.getFiles().forEach((e=>{if(e.isUploading()){e.abort();e.setStatus(l.PENDING)}}));this.emit("onStop")}cancel(){this.getFiles().forEach((e=>{e.cancel()}))}destroy(){this.emit("onDestroy");this.getFiles().forEach((e=>{e.cancel()}));for(const e in this){if(this.hasOwnProperty(e)){delete this[e]}}Object.setPrototypeOf(this,null)}removeFile(e){if(t.Type.isString(e)){e=this.getFile(e)}const i=this.files.findIndex((t=>t===e));if(i>=0){this.files.splice(i,1);e.abort();e.setStatus(l.INIT);this.emit("File:onRemove",{file:e});babelHelpers.classPrivateFieldLooseBase(this,tt)[tt](e)}}getFile(e){return this.getFiles().find((t=>t.getId()===e))||null}getFiles(){return this.files}isMultiple(){return this.multiple}getStatus(){return this.status}addFilter(e,i,s={}){if(t.Type.isFunction(i)||t.Type.isString(i)){const e=t.Type.isString(i)?t.Reflection.getClass(i):i;if(t.Type.isFunction(e)){i=new e(this,s)}}if(i instanceof V){let s=this.filters.get(e);if(!t.Type.isArray(s)){s=[];this.filters.set(e,s)}s.push(i)}else{throw new Error("Uploader: a filter must be an instance of FileUploader.Filter.")}}addFilters(e){if(t.Type.isArray(e)){e.forEach((e=>{if(t.Type.isPlainObject(e)){this.addFilter(e.type,e.filter,e.options)}}))}}getServer(){return this.server}assignBrowse(e){e=t.Type.isElementNode(e)?[e]:e;if(!t.Type.isArray(e)){return}e.forEach((e=>{if(!t.Type.isElementNode(e)){return}let i=null;if(e.tagName==="INPUT"&&e.type==="file"){i=e;if(i.files){this.addFiles(i.files)}const s=i.getAttribute("accept");if(t.Type.isStringFilled(s)){this.setAcceptedFileTypes(s)}}else{i=document.createElement("input");i.setAttribute("type","file");t.Event.bind(e,"click",(()=>{i.click()}))}if(this.isMultiple()){i.setAttribute("multiple","multiple")}if(t.Type.isArrayFilled(this.getAcceptedFileTypes())){i.setAttribute("accept",this.getAcceptedFileTypes().join(","))}t.Event.bind(i,"change",(()=>{this.addFiles(Array.from(i.files));i.value=""}))}))}assignDropzone(e){e=t.Type.isElementNode(e)?[e]:e;if(!t.Type.isArray(e)){return}e.forEach((e=>{if(!t.Type.isElementNode(e)){return}t.Event.bind(e,"dragover",(e=>{e.preventDefault()}));t.Event.bind(e,"dragenter",(e=>{e.preventDefault()}));t.Event.bind(e,"drop",(e=>{e.preventDefault();Ne(e.dataTransfer).then((e=>{this.addFiles(e)}))}))}))}assignPaste(e){e=t.Type.isElementNode(e)?[e]:e;if(!t.Type.isArray(e)){return}e.forEach((e=>{if(!t.Type.isElementNode(e)){return}t.Event.bind(e,"paste",(e=>{e.preventDefault();const t=e.clipboardData;if(!t){return}Ne(t).then((e=>{this.addFiles(e)}))}))}))}getHiddenFieldsContainer(){let e=null;if(t.Type.isStringFilled(this.hiddenFieldsContainer)){e=document.querySelector(this.hiddenFieldsContainer)}else if(t.Type.isElementNode(this.hiddenFieldsContainer)){e=this.hiddenFieldsContainer}return e}setHiddenFieldsContainer(e){if(t.Type.isStringFilled(e)||t.Type.isElementNode(e)||t.Type.isNull(e)){this.hiddenFieldsContainer=e}}getHiddenFieldName(){return this.hiddenFieldName}setHiddenFieldName(e){if(t.Type.isStringFilled(e)){this.hiddenFieldName=e}}shouldAssignAsFile(){return this.assignAsFile}setAssignAsFile(e){if(t.Type.isBoolean(e)){this.assignAsFile=e}}getTotalSize(){return this.getFiles().reduce(((e,t)=>e+t.getSize()),0)}shouldAutoUpload(){return this.autoUpload}setAutoUpload(e){if(t.Type.isBoolean(e)){this.autoUpload=e}}getMaxParallelUploads(){return this.maxParallelUploads}setMaxParallelUploads(e){if(t.Type.isNumber(e)&&e>0){this.maxParallelUploads=e}}getMaxParallelLoads(){return this.maxParallelLoads}setMaxParallelLoads(e){if(t.Type.isNumber(e)&&e>0){this.maxParallelLoads=e}}getUploadingFileCount(){return this.getFiles().filter((e=>e.isUploading())).length}getPendingFileCount(){return this.getFiles().filter((e=>e.isReadyToUpload())).length}shouldAcceptOnlyImages(){return this.acceptOnlyImages}getAcceptedFileTypes(){return this.acceptedFileTypes}setAcceptedFileTypes(e){if(t.Type.isString(e)){e=e.split(",")}if(t.Type.isArray(e)){this.acceptedFileTypes=[];e.forEach((e=>{if(t.Type.isStringFilled(e)){this.acceptedFileTypes.push(e)}}))}}getIgnoredFileNames(){return this.ignoredFileNames}setIgnoredFileNames(e){if(t.Type.isArray(e)){this.ignoredFileNames=[];e.forEach((e=>{if(t.Type.isStringFilled(e)){this.ignoredFileNames.push(e.toLowerCase())}}))}}setMaxFileCount(e){if(t.Type.isNumber(e)&&e>0||e===null){this.maxFileCount=e}}getMaxFileCount(){return this.maxFileCount}setAllowReplaceSingle(e){if(t.Type.isBoolean(e)){this.allowReplaceSingle=e}}shouldReplaceSingle(){return this.allowReplaceSingle}handleBeforeUpload(e){if(this.getStatus()===Be.STOPPED){e.preventDefault();this.start()}else{if(this.getUploadingFileCount()>=this.getMaxParallelUploads()){e.preventDefault()}}}handlePrepareFileAsync(e){return new Promise(((i,s)=>{const{file:r}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye](Me.PREPARATION,r).then((e=>{if(t.Type.isFile(e)){i(e)}else{i(r)}})).catch((e=>s(e)))}))}handleUploadStart(e){const t=e.getTarget();this.emit("File:onUploadStart",{file:t})}handleFileCancel(e){const t=e.getTarget();this.emit("File:onCancel",{file:t});this.removeFile(t)}handleFileStatusChange(e){const t=e.getTarget();this.emit("File:onStatusChange",{file:t})}handleFileStateChange(e){const t=e.getTarget();this.emit("File:onStateChange",{file:t})}}function rt(e){const t=e.getOrigin()===n.SERVER?this.getServer().createLoadController():this.getServer().createClientLoadController();t.subscribeFromOptions({onError:t=>{const{error:i}=t.getData();e.addError(i);e.setStatus(l.LOAD_FAILED);this.emit("File:onError",{file:e,error:i});babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]()},onAbort:t=>{if(e.getOrigin()===n.SERVER){e.setStatus(l.ABORTED)}else{e.setStatus(l.LOAD_FAILED)}this.emit("File:onAbort",{file:e});babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]()},onProgress:t=>{this.emit("File:onLoadProgress",{file:e,progress:t.getData().progress})},onLoad:t=>{if(e.getOrigin()===n.SERVER){e.setFile(t.getData().fileInfo);e.setStatus(l.COMPLETE);this.emit("File:onAdd",{file:e});this.emit("File:onLoadComplete",{file:e});this.emit("File:onComplete",{file:e});babelHelpers.classPrivateFieldLooseBase(this,et)[et](e);return}babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye](Me.VALIDATION,e).then((()=>{if(e.isUploadable()){e.setStatus(l.PENDING);this.emit("File:onAdd",{file:e});this.emit("File:onLoadComplete",{file:e});if(this.shouldAutoUpload()){e.upload()}}else{e.setStatus(l.COMPLETE);this.emit("File:onAdd",{file:e});this.emit("File:onLoadComplete",{file:e});this.emit("File:onComplete",{file:e})}babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]()})).catch((t=>{e.addError(t);e.setStatus(l.LOAD_FAILED);this.emit("File:onError",{file:e,error:t});this.emit("File:onAdd",{file:e,error:t});babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]()}))}});e.setLoadController(t)}function lt(e){const t=this.getServer().createUploadController();if(!t){return}t.subscribeFromOptions({onError:t=>{const{error:i}=t.getData();e.addError(i);e.setStatus(l.UPLOAD_FAILED);this.emit("File:onError",{file:e,error:i});babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]()},onAbort:t=>{e.setStatus(l.ABORTED);this.emit("File:onAbort",{file:e});babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]()},onProgress:t=>{const{progress:i}=t.getData();e.setProgress(i);this.emit("File:onUploadProgress",{file:e,progress:i})},onUpload:t=>{e.setStatus(l.COMPLETE);e.setFile(t.getData().fileInfo);this.emit("File:onUploadComplete",{file:e});this.emit("File:onComplete",{file:e});babelHelpers.classPrivateFieldLooseBase(this,et)[et](e);babelHelpers.classPrivateFieldLooseBase(this,qe)[qe]()}});e.setUploadController(t)}function nt(e){const t=e.length;const i=this.getFiles().length;if(!this.isMultiple()&&t>1){return true}let s;if(this.isMultiple()){s=this.getMaxFileCount()}else{s=this.shouldReplaceSingle()?null:1}if(s!==null&&i+t>s){const e=new U("MAX_FILE_COUNT_EXCEEDED",{maxFileCount:s});this.emit("onMaxFileCountExceeded",{error:e});this.emit("onError",{error:e});return true}return false}function at(e,...t){return new Promise(((i,s)=>{const r=[...this.filters.get(e)||[]];if(r.length===0){i();return}const l=r.shift();r.reduce(((e,i)=>e.then((()=>i.apply(...t)))),l.apply(...t)).then((e=>i(e))).catch((e=>s(e)))}))}function ot(){if(this.getStatus()!==Be.STARTED){return}const e=this.getMaxParallelUploads();const t=this.getUploadingFileCount();const i=this.getFiles().filter((e=>e.isReadyToUpload()));const s=i.length;if(t<e){const s=Math.min(e-t,i.length);for(let e=0;e<s;e++){const t=i[e];t.upload()}}if(t===0&&s===0){this.status=Be.STOPPED;this.emit("onUploadComplete")}}function ht(){const e=this.getMaxParallelLoads();const t=this.getFiles().filter((e=>e.isLoading())).length;const i=this.getFiles().filter((e=>e.getStatus()===l.ADDED&&e.getOrigin()===n.CLIENT));if(t<e){const s=Math.min(e-t,i.length);for(let e=0;e<s;e++){const t=i[e];t.load()}}}function dt(e){const i=this.getHiddenFieldsContainer();if(!i||this.hiddenFields.has(e.getId())){return}const s=t.Type.isNumber(e.getServerId());if(s){return}const r=e.getOrigin()===n.CLIENT&&!e.isUploadable()&&this.shouldAssignAsFile()&&Xe();const l=document.createElement("input");l.type=r?"file":"hidden";l.name=this.getHiddenFieldName()+(this.isMultiple()?"[]":"");if(r){t.Dom.style(l,{visibility:"hidden",left:0,top:0,width:0,height:0,position:"absolute","pointer-events":"none"});$e(l,e.getFile())}else if(e.getServerId()!==null){l.value=e.getServerId()}i.appendChild(l);this.hiddenFields.set(e.getId(),l);babelHelpers.classPrivateFieldLooseBase(this,it)[it]()}function ct(e){const i=this.hiddenFields.get(e.getId());if(i){t.Dom.remove(i);this.hiddenFields.delete(e.getId())}}function ut(){const e=this.getHiddenFieldsContainer();if(!e){return}this.getFiles().forEach((t=>{const i=this.hiddenFields.get(t.getId());if(i){e.appendChild(i)}}))}var gt=babelHelpers.classPrivateFieldLooseKey("uploader");var pt=babelHelpers.classPrivateFieldLooseKey("items");var ft=babelHelpers.classPrivateFieldLooseKey("uploaderError");var mt=babelHelpers.classPrivateFieldLooseKey("getItemsArray");var Ft=babelHelpers.classPrivateFieldLooseKey("getItem");var vt=babelHelpers.classPrivateFieldLooseKey("handleFileAdd");var bt=babelHelpers.classPrivateFieldLooseKey("handleFileRemove");var yt=babelHelpers.classPrivateFieldLooseKey("handleFileStateChange");var Pt=babelHelpers.classPrivateFieldLooseKey("handleError");var wt=babelHelpers.classPrivateFieldLooseKey("handleUploadStart");var St=babelHelpers.classPrivateFieldLooseKey("handleUploadComplete");class Et extends i.EventEmitter{constructor(e){super();Object.defineProperty(this,St,{value:Ht});Object.defineProperty(this,wt,{value:It});Object.defineProperty(this,Pt,{value:At});Object.defineProperty(this,yt,{value:Ot});Object.defineProperty(this,bt,{value:Ct});Object.defineProperty(this,vt,{value:Lt});Object.defineProperty(this,Ft,{value:Ut});Object.defineProperty(this,mt,{value:Tt});Object.defineProperty(this,gt,{writable:true,value:null});Object.defineProperty(this,pt,{writable:true,value:null});Object.defineProperty(this,ft,{writable:true,value:null});this.setEventNamespace("BX.UI.Uploader.Vue.Adapter");babelHelpers.classPrivateFieldLooseBase(this,pt)[pt]=r.ref([]);babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]=r.shallowRef(null);const i=t.Type.isPlainObject(e)?Object.assign({},e):{};const l=i.events;i.events={"File:onAddStart":babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].bind(this),"File:onRemove":babelHelpers.classPrivateFieldLooseBase(this,bt)[bt].bind(this),"File:onStateChange":babelHelpers.classPrivateFieldLooseBase(this,yt)[yt].bind(this),onError:babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt].bind(this),onUploadStart:babelHelpers.classPrivateFieldLooseBase(this,wt)[wt].bind(this),onUploadComplete:babelHelpers.classPrivateFieldLooseBase(this,St)[St].bind(this)};babelHelpers.classPrivateFieldLooseBase(this,gt)[gt]=new s.Uploader(i);babelHelpers.classPrivateFieldLooseBase(this,gt)[gt].subscribeFromOptions(l)}getUploader(){return babelHelpers.classPrivateFieldLooseBase(this,gt)[gt]}getItems(){return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt]}getUploaderError(){return babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]}}function Tt(){return babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].value}function Ut(e){return babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]().find((t=>t.id===e))}function Lt(e){const{file:t}=e.getData();const i=t.getState();babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]().push(i);this.emit("Item:onAdd",{item:i})}function Ct(e){const{file:t}=e.getData();const i=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]().findIndex((e=>e.id===t.getId()));if(i>=0){const e=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]().splice(i,1);this.emit("Item:onRemove",{item:e[0]})}}function Ot(e){const{file:t}=e.getData();const i=babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft](t.getId());if(i){Object.assign(i,t.getState())}}function At(e){const{error:t}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,ft)[ft].value=t.toJSON();this.emit("Uploader:onError",e)}function It(e){this.emit("Uploader:onUploadStart",e)}function Ht(e){this.emit("Uploader:onUploadComplete",e)}var zt=babelHelpers.classPrivateFieldLooseKey("vueAdapter");var Dt=babelHelpers.classPrivateFieldLooseKey("uploaderOptions");var Rt=babelHelpers.classPrivateFieldLooseKey("widgetOptions");var Bt=babelHelpers.classPrivateFieldLooseKey("vueApp");class Mt extends i.EventEmitter{constructor(e,t={}){super();Object.defineProperty(this,zt,{writable:true,value:null});Object.defineProperty(this,Dt,{writable:true,value:null});Object.defineProperty(this,Rt,{writable:true,value:{}});Object.defineProperty(this,Bt,{writable:true,value:null});this.setEventNamespace("BX.UI.Uploader.Vue.Widget");babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt]=e;babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt]=t}getRootComponent(){return null}getAdapter(){if(babelHelpers.classPrivateFieldLooseBase(this,zt)[zt]===null){babelHelpers.classPrivateFieldLooseBase(this,zt)[zt]=new Et(babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt])}return babelHelpers.classPrivateFieldLooseBase(this,zt)[zt]}getUploader(){return this.getAdapter().getUploader()}getVueApp(){if(babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]!==null){return babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]}babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]=r.BitrixVue.createApp(this.getRootComponent(),{uploaderOptions:babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt],widgetOptions:babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],uploaderAdapter:this.getAdapter()});return babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]}renderTo(e){if(t.Type.isDomNode(e)){this.getVueApp().mount(e)}}}const Nt={name:"VueUploaderComponent",props:{uploaderOptions:{type:Object},widgetOptions:{type:Object,default:{}},uploaderAdapter:{type:Object,default:null}},data:()=>({items:[],uploaderError:null}),provide(){return{uploader:this.uploader,adapter:this.adapter,widgetOptions:this.widgetOptions}},beforeCreate(){this.adapter=this.uploaderAdapter===null?new Et(this.uploaderOptions):this.uploaderAdapter;this.uploader=this.adapter.getUploader()},created(){this.items=this.adapter.getItems();this.uploaderError=this.adapter.getUploaderError()},mounted(){if(!this.uploader.getHiddenFieldsContainer()){this.uploader.setHiddenFieldsContainer(this.$el)}}};const xt=e=>/^image\/[a-z0-9.-]+$/i.test(e.type);var kt=Object.freeze({formatFileSize:y,getFileExtension:F,getFilenameWithoutExtension:Te,getExtensionFromType:c,getArrayBuffer:G,isDataUri:f,isImage:xt,isResizableImage:b,getImageSize:be,resizeImage:He,loadImage:Se,isValidFileType:X,canAppendFileToForm:Xe,assignFileToInput:$e,createFileFromBlob:g,createBlobFromDataUri:m,createUniqueId:d,createWorker:Pe});e.Uploader=st;e.UploaderStatus=Be;e.FileStatus=l;e.FileOrigin=n;e.FilterType=Me;e.Helpers=kt;e.VueUploaderWidget=Mt;e.VueUploaderComponent=Nt})(this.BX.UI.Uploader=this.BX.UI.Uploader||{},BX,BX.Event,BX.UI.Uploader,BX.Vue3);
//# sourceMappingURL=ui.uploader.bundle.map.js